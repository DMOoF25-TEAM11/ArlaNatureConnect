<?xml version="1.0" encoding="utf-8"?>
<UserControl
  x:Class="ArlaNatureConnect.WinUI.Views.Controls.SharedUC.CRUDPersonUC"
  x:Name="Root"
  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
  xmlns:local="using:ArlaNatureConnect.WinUI.Views.Controls.SharedUC"
  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
  xmlns:shareduc="using:ArlaNatureConnect.WinUI.ViewModels.Controls.SharedUC" 
  xmlns:conv="using:ArlaNatureConnect.WinUI.Converters"
  d:DataContext="{d:DesignInstance Type=shareduc:CRUDPersonUCViewModel}"
  mc:Ignorable="d">
  <UserControl.Resources>
    <conv:AlternationToBrushConverter x:Key="AlternationToBrushConverter" />
    <conv:IntToVisibilityConverter x:Key="IntToVisibilityConverter" />
  </UserControl.Resources>

  <Grid Padding="24" Background="{StaticResource AppBackgroundBrush}">
    <Grid.ColumnDefinitions>
      <ColumnDefinition Width="400"/>
      <ColumnDefinition Width="*"/>
    </Grid.ColumnDefinitions>

      <!-- Left: Person Details Form -->
      <Border Grid.Column="0"
              Style="{StaticResource ArlaCard}"
              Background="{StaticResource ArlaSurfaceBrush}"
              Margin="8,0,12,8"
              VerticalAlignment="Top">
        <StackPanel Orientation="Vertical" Spacing="16">
          <TextBlock Text="Person Detaljer"
                     Style="{StaticResource ArlaSubHeaderText}"
                     Margin="0,0,0,8"/>

          <StackPanel Orientation="Vertical" Spacing="12">
            <StackPanel Orientation="Vertical" Spacing="4">
              <TextBlock Text="{Binding LabelFirstName, Mode=OneTime}" 
                         Style="{StaticResource ArlaBodyText}"
                         FontWeight="SemiBold"/>
              <TextBox Text="{Binding FirstName, Mode=TwoWay}" 
                       Style="{StaticResource ArlaTextBox}"/>
            </StackPanel>

            <StackPanel Orientation="Vertical" Spacing="4">
              <TextBlock Text="{Binding LabelLastName, Mode=OneTime}" 
                         Style="{StaticResource ArlaBodyText}"
                         FontWeight="SemiBold"/>
              <TextBox Text="{Binding LastName, Mode=TwoWay}" 
                       Style="{StaticResource ArlaTextBox}"/>
            </StackPanel>

            <StackPanel Orientation="Vertical" Spacing="4">
              <TextBlock Text="{Binding LabelAddress, Mode=OneTime}" 
                         Style="{StaticResource ArlaBodyText}"
                         FontWeight="SemiBold"/>
              <Border Background="{StaticResource ArlaNeutralLighterBrush}"
                      BorderBrush="{StaticResource ArlaPrimaryBrush}"
                      BorderThickness="2"
                      CornerRadius="8"
                      Padding="12,8">
                <TextBlock Text="{Binding AddressDisplay, Mode=OneWay}" 
                           Style="{StaticResource ArlaBodyText}"/>
              </Border>
            </StackPanel>

            <StackPanel Orientation="Vertical" Spacing="4">
              <TextBlock Text="{Binding LabelEmail, Mode=OneTime}" 
                         Style="{StaticResource ArlaBodyText}"
                         FontWeight="SemiBold"/>
              <TextBox Text="{Binding Email, Mode=TwoWay}" 
                       Style="{StaticResource ArlaTextBox}"/>
            </StackPanel>

            <StackPanel Orientation="Vertical" Spacing="4">
              <TextBlock Text="{Binding LabelIsActive, Mode=OneTime}" 
                         Style="{StaticResource ArlaBodyText}"
                         FontWeight="SemiBold"/>
              <ToggleSwitch IsOn="{Binding IsActive, Mode=TwoWay}" 
                            OnContent="Aktiv"
                            OffContent="Inaktiv"/>
            </StackPanel>

            <StackPanel Orientation="Vertical" Spacing="4">
              <TextBlock Text="{Binding LabelRole, Mode=OneTime}" 
                         Style="{StaticResource ArlaBodyText}"
                         FontWeight="SemiBold"/>
              <ComboBox ItemsSource="{Binding Roles}"
                        SelectedItem="{Binding SelectedRole, Mode=TwoWay}"
                        DisplayMemberPath="Name"
                        Style="{StaticResource ArlaComboBox}"/>
            </StackPanel>
          </StackPanel>

          <!-- Action Buttons - 2 rows -->
          <StackPanel Orientation="Vertical" 
                     HorizontalAlignment="Center" 
                     Spacing="6" 
                     Margin="0,16,0,0">
            <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
              <Button Content="Tilføj" 
                      Command="{Binding AddCommand}"
                      Background="{StaticResource ArlaPrimaryBrush}"
                      Foreground="{StaticResource ArlaNeutralLightBrush}"
                      BorderBrush="{StaticResource ArlaPrimaryDarkBrush}"
                      BorderThickness="1.5"
                      Padding="16,8"
                      FontWeight="Bold"
                      FontSize="14"
                      MinWidth="100"
                      MinHeight="40"
                      CornerRadius="6"/>
              <Button Content="Gem" 
                      Command="{Binding SaveCommand}"
                      Background="{StaticResource ArlaPrimaryLightBrush}"
                      Foreground="{StaticResource ArlaPrimaryDarkBrush}"
                      BorderBrush="{StaticResource ArlaPrimaryDarkBrush}"
                      BorderThickness="1.5"
                      Padding="16,8"
                      FontWeight="Bold"
                      FontSize="14"
                      MinWidth="100"
                      MinHeight="40"
                      CornerRadius="6"/>
              <Button Content="Slet" 
                      Command="{Binding DeleteCommand}"
                      Background="{StaticResource ArlaErrorBrush}"
                      Foreground="{StaticResource ArlaNeutralLightBrush}"
                      BorderBrush="{StaticResource ArlaErrorBrush}"
                      BorderThickness="1.5"
                      Padding="16,8"
                      FontWeight="Bold"
                      FontSize="14"
                      MinWidth="100"
                      MinHeight="40"
                      CornerRadius="6"/>
            </StackPanel>
            <StackPanel Orientation="Horizontal" Spacing="6" HorizontalAlignment="Center">
              <Button Content="Annuller" 
                      Command="{Binding CancelCommand}"
                      Background="{StaticResource ArlaLightGreyBrush}"
                      Foreground="{StaticResource ArlaNeutralDarkBrush}"
                      BorderBrush="{StaticResource ArlaLightGreyBrush}"
                      BorderThickness="1.5"
                      Padding="16,8"
                      FontWeight="Bold"
                      FontSize="14"
                      MinWidth="100"
                      MinHeight="40"
                      CornerRadius="6"/>
              <Button Content="Opdater" 
                      Command="{Binding RefreshCommand}"
                      Background="{StaticResource ArlaSurfaceBrush}"
                      Foreground="{StaticResource ArlaNeutralDarkBrush}"
                      BorderBrush="{StaticResource ArlaNeutralDarkBrush}"
                      BorderThickness="2"
                      Padding="16,8"
                      FontWeight="Bold"
                      FontSize="14"
                      MinWidth="100"
                      MinHeight="40"
                      CornerRadius="6"/>
            </StackPanel>
          </StackPanel>
        </StackPanel>
      </Border>

      <!-- Right: Search and Person List -->
      <StackPanel Grid.Column="1" Orientation="Vertical" Spacing="12" VerticalAlignment="Top">
        <Border Style="{StaticResource ArlaCard}"
                Background="{StaticResource ArlaSurfaceBrush}"
                Margin="8,0,8,8"
                VerticalAlignment="Top">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto"/>
              <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

          <!-- Search Section -->
          <Border Grid.Row="0" 
                  Background="Transparent"
                  Margin="0,0,0,16"
                  Padding="0">
            <StackPanel Orientation="Horizontal" Spacing="12">
              <TextBlock Text="Søg navn" 
                         VerticalAlignment="Center"
                         Style="{StaticResource ArlaBodyText}"
                         FontWeight="SemiBold"
                         Foreground="{StaticResource ArlaPrimaryDarkBrush}"/>
              <TextBox Text="{Binding SearchText, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                       Style="{StaticResource ArlaTextBox}"
                       Width="400"
                       PlaceholderText="Søg efter fornavn, efternavn eller email"/>
            </StackPanel>
          </Border>

          <!-- Person ListView with horizontal scroll - Header and content scroll -->
          <ScrollViewer Grid.Row="1"
                        ZoomMode="Disabled"
                        HorizontalScrollBarVisibility="Auto"
                        VerticalScrollBarVisibility="Auto"
                        MaxHeight="400">
            <StackPanel Orientation="Vertical">
              <!-- List Header -->
              <Border BorderBrush="{StaticResource ArlaPrimaryDarkBrush}"
                      BorderThickness="0,0,0,2"
                      Margin="0,0,0,0"
                      Padding="0,4,0,4">
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="60"/>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="200"/>
                  </Grid.ColumnDefinitions>
                  <Button Grid.Column="0"
                          Content="{Binding LabelFirstName, Mode=OneTime}"
                          FontWeight="SemiBold"
                          Command="{Binding SortCommand}"
                          CommandParameter="FirstName"
                          Background="Transparent"
                          BorderThickness="0"
                          Foreground="{StaticResource ArlaPrimaryDarkBrush}"/>
                  <Button Grid.Column="1"
                          Content="{Binding LabelLastName, Mode=OneTime}"
                          FontWeight="SemiBold"
                          Command="{Binding SortCommand}"
                          CommandParameter="LastName"
                          Background="Transparent"
                          BorderThickness="0"
                          Foreground="{StaticResource ArlaPrimaryDarkBrush}"/>
                  <Button Grid.Column="2"
                          Content="{Binding LabelRole, Mode=OneTime}"
                          FontWeight="SemiBold"
                          Command="{Binding SortCommand}"
                          CommandParameter="Role.Name"
                          Background="Transparent"
                          BorderThickness="0"
                          Foreground="{StaticResource ArlaPrimaryDarkBrush}"/>
                  <Button Grid.Column="3"
                          Content="{Binding LabelIsActive, Mode=OneTime}"
                          FontWeight="SemiBold"
                          Command="{Binding SortCommand}"
                          CommandParameter="IsActive"
                          Background="Transparent"
                          BorderThickness="0"
                          Foreground="{StaticResource ArlaPrimaryDarkBrush}"/>
                  <Button Grid.Column="4"
                          Content="{Binding LabelFarms, Mode=OneTime}"
                          FontWeight="SemiBold"
                          Command="{Binding SortCommand}"
                          CommandParameter="Farms.Count"
                          Background="Transparent"
                          BorderThickness="0"
                          Foreground="{StaticResource ArlaPrimaryDarkBrush}"/>
                  <Button Grid.Column="5"
                          Content="{Binding LabelAddress, Mode=OneTime}"
                          FontWeight="SemiBold"
                          Command="{Binding SortCommand}"
                          CommandParameter="Address.PostalCode"
                          Background="Transparent"
                          BorderThickness="0"
                          Foreground="{StaticResource ArlaPrimaryDarkBrush}"/>
                  <Button Grid.Column="6"
                          Content="{Binding LabelEmail, Mode=OneTime}"
                          FontWeight="SemiBold"
                          Command="{Binding SortCommand}"
                          CommandParameter="Email"
                          Background="Transparent"
                          BorderThickness="0"
                          Foreground="{StaticResource ArlaPrimaryDarkBrush}"/>
                </Grid>
              </Border>

              <!-- ListView Content -->
              <ListView x:Name="PersonList"
                        ItemsSource="{Binding FilteredItems, Mode=OneWay}"
                        SelectedItem="{Binding SelectedItem, Mode=TwoWay}"
                        SelectionMode="Single"
                        Margin="0,-2,0,0">
            <ListView.ItemContainerStyle>
              <Style TargetType="ListViewItem">
                <Setter Property="Padding" Value="0"/>
                <Setter Property="Margin" Value="0,0,0,1"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                <Setter Property="VerticalContentAlignment" Value="Stretch"/>
                <Setter Property="MinHeight" Value="40"/>
              </Style>
            </ListView.ItemContainerStyle>

            <ListView.ItemTemplate>
              <DataTemplate>
                <Border BorderBrush="{StaticResource ArlaPrimaryDarkBrush}" 
                        BorderThickness="0,0,0,1" 
                        Background="{Binding DataContext.ItemCounter, ElementName=Root, Converter={StaticResource AlternationToBrushConverter}}"
                        Padding="4,8">
                  <Grid>
                    <Grid.ColumnDefinitions>
                      <ColumnDefinition Width="120"/>
                      <ColumnDefinition Width="120"/>
                      <ColumnDefinition Width="120"/>
                      <ColumnDefinition Width="60"/>
                      <ColumnDefinition Width="120"/>
                      <ColumnDefinition Width="200"/>
                      <ColumnDefinition Width="200"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" 
                               Text="{Binding FirstName}" 
                               VerticalAlignment="Center"
                               Style="{StaticResource ArlaBodyText}"/>

                    <TextBlock Grid.Column="1" 
                               Text="{Binding LastName}" 
                               VerticalAlignment="Center"
                               Style="{StaticResource ArlaBodyText}"/>

                    <TextBlock Grid.Column="2" 
                               Text="{Binding Role.Name}" 
                               VerticalAlignment="Center"
                               Style="{StaticResource ArlaBodyText}"/>

                    <Grid Grid.Column="3" VerticalAlignment="Center" HorizontalAlignment="Center">
                      <TextBlock Text="✔" 
                                 Foreground="{StaticResource ArlaPrimaryBrush}"
                                 FontSize="16"
                                 FontWeight="Bold"
                                 Visibility="{Binding IsActive, Converter={StaticResource BoolToVis}}"/>
                    </Grid>

                    <Grid Grid.Column="4" VerticalAlignment="Center">
                      <Ellipse Width="24" 
                               Height="24" 
                               Fill="{StaticResource ArlaPrimaryBrush}"
                               Visibility="{Binding Farms.Count, Converter={StaticResource IntToVisibilityConverter}}"/>
                      <TextBlock Text="{Binding Farms.Count}" 
                                 HorizontalAlignment="Center"
                                 VerticalAlignment="Center"
                                 Foreground="{StaticResource ArlaNeutralLightBrush}"
                                 FontWeight="Bold"
                                 FontSize="12"
                                 Visibility="{Binding Farms.Count, Converter={StaticResource IntToVisibilityConverter}}"/>
                    </Grid>

                    <TextBlock Grid.Column="5" 
                               VerticalAlignment="Center"
                               Style="{StaticResource ArlaBodyText}">
                      <Run Text="{Binding Address.PostalCode}"/>
                      <Run Text=", "/>
                      <Run Text="{Binding Address.Street}"/>
                    </TextBlock>

                    <TextBlock Grid.Column="6" 
                               Text="{Binding Email}" 
                               VerticalAlignment="Center"
                               Style="{StaticResource ArlaBodyText}"/>
                  </Grid>
                </Border>
              </DataTemplate>
            </ListView.ItemTemplate>
          </ListView>
            </StackPanel>
          </ScrollViewer>
          </Grid>
        </Border>

        <!-- Farms List (only visible for Farmers) - Separate card under search and list -->
        <Border Style="{StaticResource ArlaCard}"
                Background="{StaticResource ArlaSurfaceBrush}"
                Visibility="{Binding IsFarmer, Converter={StaticResource BoolToVis}}"
                MaxHeight="300">
          <StackPanel Orientation="Vertical" Spacing="8">
            <TextBlock Text="Tilknyttede Gårde"
                       Style="{StaticResource ArlaSubHeaderText}"
                       Margin="0,0,0,8"/>
            <ListView ItemsSource="{Binding SelectedPersonFarms, Mode=OneWay}"
                      MaxHeight="200">
              <ListView.ItemTemplate>
                <DataTemplate>
                  <Border BorderBrush="{StaticResource ArlaLightGreyBrush}"
                          BorderThickness="0,0,0,1"
                          Padding="8,4">
                    <StackPanel Orientation="Horizontal" Spacing="12">
                      <TextBlock Text="{Binding Name}" 
                                 Style="{StaticResource ArlaBodyText}"
                                 FontWeight="SemiBold"
                                 MinWidth="200"/>
                      <TextBlock Style="{StaticResource ArlaBodyText}">
                        <Run Text="CVR: "/>
                        <Run Text="{Binding CVR}"/>
                      </TextBlock>
                      <TextBlock Style="{StaticResource ArlaBodyText}">
                        <Run Text="{Binding Address.PostalCode}"/>
                        <Run Text=" "/>
                        <Run Text="{Binding Address.Street}"/>
                      </TextBlock>
                    </StackPanel>
                  </Border>
                </DataTemplate>
              </ListView.ItemTemplate>
            </ListView>
          </StackPanel>
        </Border>
      </StackPanel>
    </Grid>
  </UserControl>
