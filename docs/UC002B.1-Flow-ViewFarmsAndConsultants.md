# UC002B.1 - Komplet Flow: Vis GÃ¥rde og Konsulenter (fra UI til Database og tilbage)

## ğŸ“ Oversigt

Dette dokument viser hele processen fra nÃ¥r brugeren (Arla medarbejder) Ã¥bner siden for at tildele Natur Check opgaver, gennem alle lag, til data bliver hentet fra databasen og vist i UI'en.

**âš ï¸ VIGTIGT:** 
- **SD diagrammet** er en abstraktion der viser hovedflowet. Det skal bruges til eksamen.
- **Faktisk kode** har ekstra detaljer (EnsureAssignmentDataAsync caching, exception handling) som ikke er vist i SD'en.
- Dette dokument viser **bÃ¥de SD'en struktur** (for eksamen) og **den faktiske kode struktur** (for forstÃ¥else).

**âœ… Hvad matcher 100% mellem SD'en, koden og dette dokument:**
- âœ… **Service layer flow** - RÃ¦kkefÃ¸lgen af repository kald matcher prÃ¦cist (FarmRepo â†’ PersonRepo â†’ AddressRepo â†’ CaseRepo)
- âœ… **Repository kald** - Alle metodenavne og return types matcher
- âœ… **DTO creation** - NatureCheckCaseAssignmentContext oprettes identisk
- âœ… **ViewModel updates** - UpdateFarms() og UpdateConsultants() kaldes i samme rÃ¦kkefÃ¸lge

**âš ï¸ Forskelle mellem SD'en og koden (SD'en er abstraktion):**
- SD'en viser `BeginLoading()` - Koden bruger `BeginLoadingOrSaving()` (via EnsureAssignmentDataAsync)
- SD'en viser `InitializeAsync()` direkte - Koden kalder `EnsureAssignmentDataAsync()` med caching logic
- SD'en viser ikke caching - Koden har `_assignmentLoaded` flag for at undgÃ¥ unÃ¸dvendige reloads

---

## ğŸ¯ Start: Brugeren Ã¥bner siden

### 1. UI Layer (WinUI)
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`  
**Metode:** `InitializeAsync()` (linje 291)

**Hvad sker der?**
1. Brugeren (Arla medarbejder) navigerer til siden for at tildele Natur Check opgaver
2. UI kalder `InitializeAsync()` nÃ¥r siden indlÃ¦ses
3. ViewModel skal hente alle gÃ¥rde og konsulenter for at vise dem i dropdowns

**Interface/Arv:**
- Arver fra `ViewModelBase` (base klasse)
- Bruger `INatureCheckCaseService` (dependency injection)
- Bruger `IStatusInfoServices` (dependency injection)

---

## ğŸ”„ ViewModel Layer (WinUI)

### 2. ViewModel - Initialize Method
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`  
**Metode:** `InitializeAsync()` (linje 291)

**Note:** Dette flow fÃ¸lger SD diagrammet prÃ¦cist. SD diagrammet viser `InitializeAsync()` â†’ `LoadAssignmentContextAsync()` â†’ `UpdateFarms()` â†’ `UpdateConsultants()`.

```csharp
// Hvad sker der (som vist i SD diagrammet):
// 1. Kalder BeginLoading() (StatusService)
// 2. Kalder Service.LoadAssignmentContextAsync()
// 3. Hvis success: Opdaterer farms og consultants
// 4. Kalder StatusService.Dispose()
```

**Hvad gÃ¸r metoden? (Faktisk kode vs SD diagrammet)**

**Faktisk kode struktur (linje 291-294):**
- **Step 1:** Kalder `EnsureAssignmentDataAsync()` (ikke direkte `LoadAssignmentContextAsync()` som i SD'en)
  - `EnsureAssignmentDataAsync()` (linje 365-394) har caching logic:
    - Tjekker `_assignmentLoaded` flag
    - Hvis allerede loaded og `forceReload == false`: Returnerer tidligt
    - Hvis ikke loaded eller `forceReload == true`: FortsÃ¦tter med loading

**Faktisk kode struktur i EnsureAssignmentDataAsync (linje 365-394):**
- **Step 1:** Tjekker caching (ikke i SD'en, men i koden):
  - `if (_assignmentLoaded && !forceReload) return;` - UndgÃ¥r unÃ¸dvendige reloads
- **Step 2:** Wrapper med loading state (som i SD'en):
  - `using IDisposable loading = _statusInfoServices.BeginLoadingOrSaving();` (ikke `BeginLoading()` som i SD'en)
- **Step 3:** Kalder Service (som i SD'en):
  - `NatureCheckCaseAssignmentContext context = await _natureCheckCaseService.LoadAssignmentContextAsync();`
- **Step 4:** Validerer context (ikke i SD'en, men i koden):
  - Hvis `context == null`: Viser fejlbesked og returnerer
- **Step 5:** Opdaterer ViewModel (som i SD'en):
  - `UpdateFarms(context.Farms);` (linje 384)
  - `UpdateConsultants(context.Consultants);` (linje 385)
- **Step 6:** SÃ¦tter flag (ikke i SD'en, men i koden):
  - `_assignmentLoaded = true;` (linje 387)
- **Step 7:** Exception handling (ikke i SD'en, men i koden):
  - Hvis exception: Viser fejlbesked og resetter `_assignmentLoaded` flag

**Interfaces den bruger:**
- `INatureCheckCaseService` - For at hente assignment context
- `IStatusInfoServices` - For loading state
- `IAppMessageService` - For fejlbeskeder

**Arv:**
- Arver fra `ViewModelBase` (base klasse for alle ViewModels)

---

## ğŸ¯ Service Layer (Core)

### 3. Core Layer - Service Interface
**Mappe:** `src/ArlaNatureConnect.Core/Services/`  
**Interface:** `INatureCheckCaseService`  
**Metode:** `LoadAssignmentContextAsync(CancellationToken cancellationToken = default)`

**Hvad er det?**
- Interface der definerer hvad service skal kunne
- ViewModel kender kun interface, ikke konkrete implementeringer

### 4. Core Layer - Service Implementation
**Mappe:** `src/ArlaNatureConnect.Core/Services/`  
**Klasse:** `NatureCheckCaseService`  
**Metode:** `LoadAssignmentContextAsync()` (linje 53)

**Note:** Dette flow fÃ¸lger SD diagrammet prÃ¦cist. RÃ¦kkefÃ¸lgen af repository kald matcher SD'en.

```csharp
// Hvad sker der (som vist i SD diagrammet):
// 1. Henter alle gÃ¥rde (FarmRepo.GetAllAsync)
// 2. Henter alle personer (PersonRepo.GetAllAsync)
// 3. Henter konsulenter (PersonRepo.GetPersonsByRoleAsync("Consultant"))
// 4. Henter alle adresser (AddressRepo.GetAllAsync)
// 5. Henter aktive cases (CaseRepo.GetActiveCasesAsync)
// 6. Opretter FarmAssignmentOverviewDto liste (CreateFarmAssignmentOverviewDto)
// 7. Returnerer NatureCheckCaseAssignmentContext
```

**Hvad gÃ¸r metoden? (FÃ¸lger bÃ¥de SD diagrammet og faktisk kode - rÃ¦kkefÃ¸lge matcher prÃ¦cist)**

**Note:** Service layer flow matcher 100% med bÃ¥de SD'en og koden. RÃ¦kkefÃ¸lgen af repository kald er identisk.

- **Step 1:** Henter alle gÃ¥rde: `await _farmRepository.GetAllAsync(cancellationToken)` (linje 56)
  - Returnerer `List<Farm>`
- **Step 2:** Henter alle personer: `await _personRepository.GetAllAsync(cancellationToken)` (linje 57)
  - Returnerer `List<Person>`
- **Step 3:** Henter konsulenter: `await _personRepository.GetPersonsByRoleAsync(RoleName.Consultant.ToString(), cancellationToken)` (linje 58)
  - Returnerer `List<Person>` (kun konsulenter)
- **Step 4:** Henter alle adresser: `await _addressRepository.GetAllAsync(cancellationToken)` (linje 59)
  - Returnerer `List<Address>`
- **Step 5:** Henter aktive cases: `await _natureCheckCaseRepository.GetActiveCasesAsync(cancellationToken)` (linje 60)
  - Returnerer `IReadOnlyList<NatureCheckCase>`
- **Step 6:** Opretter dictionaries for hurtig lookup (ikke i SD'en, men i koden):
  - `Dictionary<Guid, Person> personsById` (linje 62)
  - `Dictionary<Guid, Address> addressesById` (linje 63)
  - `HashSet<Guid> activeFarmIds` (linje 65-67)
  - `Dictionary<Guid, NatureCheckCase> activeCasesByFarm` (linje 69-72)
- **Step 7:** Opretter FarmAssignmentOverviewDto liste (som `CreateFarmAssignmentOverviewDto()` i SD'en, linje 74-77):
  - Mapper hver farm til en DTO med farm info, owner info, og active case status
  - Sorterer alfabetisk efter farm navn
- **Step 8:** Sorterer konsulenter (ikke i SD'en, men i koden, linje 79-82):
  - Sorterer alfabetisk efter fornavn, derefter efternavn
- **Step 9:** Returnerer context (linje 84):
  - `return new NatureCheckCaseAssignmentContext(overview, sortedConsultants);`

**Interfaces den bruger:**
- `IFarmRepository` - For at hente gÃ¥rde
- `IPersonRepository` - For at hente personer og konsulenter
- `IAddressRepository` - For at hente adresser
- `INatureCheckCaseRepository` - For at hente aktive cases

---

## ğŸ—„ï¸ Repository Layer (Infrastructure)

### 5. Repository Interfaces (Core.Abstract)
**Mappe:** `src/ArlaNatureConnect.Core/Abstract/`  
**Interfaces:** `IFarmRepository`, `IPersonRepository`, `IAddressRepository`, `INatureCheckCaseRepository`

**Hvad er det?**
- Interfaces der definerer hvad repositories skal kunne
- Service kender kun interfaces, ikke konkrete implementeringer

### 6. Repository Implementations (Infrastructure)
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Repositories/`  
**Base:** `Repository<TEntity>`  
**Concrete:** `FarmRepository`, `PersonRepository`, `AddressRepository`, `NatureCheckCaseRepository`

**Metoder der kaldes:**
- `GetAllAsync()` - Henter alle entities (arver fra base `Repository<TEntity>`)
- `GetPersonsByRoleAsync()` - Henter personer med specifik rolle (kun i `PersonRepository`)

**Hvad sker der?**
- Repositories kalder EF Core `DbContext` for at hente data
- EF Core oversÃ¦tter LINQ queries til SQL
- SQL kÃ¸res mod databasen
- Resultater mappes tilbage til C# entities

---

## ğŸ—„ï¸ EF Core Layer

### 7. EF Core Layer
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Persistence/`  
**Klasse:** `AppDbContext`  
**DbSets:** `Farms`, `Persons`, `Addresses`, `NatureCheckCases`

**Hvad sker der?**
- EF Core oversÃ¦tter LINQ queries til SQL
- SQL kÃ¸res mod SQL Server databasen
- Resultater mappes tilbage til C# entities

**SQL der genereres (approksimativt):**
```sql
-- FarmRepo.GetAllAsync()
SELECT * FROM FARMS;

-- PersonRepo.GetAllAsync()
SELECT * FROM PERSONS;

-- PersonRepo.GetPersonsByRoleAsync("Consultant")
SELECT p.* FROM PERSONS p
INNER JOIN ROLES r ON p.RoleId = r.Id
WHERE r.Name = 'Consultant';

-- AddressRepo.GetAllAsync()
SELECT * FROM ADDRESSES;

-- CaseRepo.GetActiveCasesAsync()
SELECT * FROM NATURE_CHECK_CASES
WHERE Status IN ('Assigned', 'InProgress');
```

---

## ğŸ—„ï¸ Database (SQL Server)

### 8. Database Tables
**Tabeller:** `FARMS`, `PERSONS`, `ADDRESSES`, `NATURE_CHECK_CASES`, `ROLES`

**Hvad sker der?**
- SQL queries kÃ¸res mod databasen
- Data returneres som result sets
- EF Core mapper result sets til C# entities

---

## ğŸ”„ Tilbage gennem lagene

### 9. Data flyder tilbage gennem lagene

1. **Database â†’ EF Core:**
   - SQL result sets returneres
   - EF Core mapper til C# entities

2. **EF Core â†’ Repository:**
   - Entities returneres til repositories
   - Repositories returnerer entities til service

3. **Repository â†’ Service:**
   - Service modtager entities fra repositories
   - Service mapper entities til DTOs
   - Service returnerer `NatureCheckCaseAssignmentContext` til ViewModel

4. **Service â†’ ViewModel:**
   - ViewModel modtager context
   - ViewModel opdaterer collections: `UpdateFarms()` og `UpdateConsultants()`
   - ViewModel sÃ¦tter `_assignmentLoaded = true`

5. **ViewModel â†’ UI:**
   - UI bindings opdateres automatisk
   - Dropdowns viser gÃ¥rde og konsulenter
   - Loading indicator forsvinder

---

## ğŸ“Š Komplet Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. UI LAYER (WinUI)                                         â”‚
â”‚    Brugeren Ã¥bner siden                                     â”‚
â”‚    â†“ kalder                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. VIEWMODEL LAYER (WinUI)                                  â”‚
â”‚    Mappe: ViewModels/Pages/                                  â”‚
â”‚    Klasse: ArlaEmployeeAssignNatureCheckViewModel           â”‚
â”‚    Metode: InitializeAsync() (linje 291)                   â”‚
â”‚    â†“ kalder EnsureAssignmentDataAsync() (linje 365)        â”‚
â”‚    â†“ kalder                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SERVICE INTERFACE (Core.Services)                        â”‚
â”‚    Interface: INatureCheckCaseService                        â”‚
â”‚    Metode: LoadAssignmentContextAsync()                     â”‚
â”‚    â†“ implementeret af                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. SERVICE IMPLEMENTATION (Core.Services)                  â”‚
â”‚    Klasse: NatureCheckCaseService                           â”‚
â”‚    Metode: LoadAssignmentContextAsync() (linje 53)          â”‚
â”‚    â†“ kalder repositories i rÃ¦kkefÃ¸lge (prÃ¦cis som i SD'en):â”‚
â”‚      1. FarmRepo.GetAllAsync()                             â”‚
â”‚      2. PersonRepo.GetAllAsync()                           â”‚
â”‚      3. PersonRepo.GetPersonsByRoleAsync("Consultant")     â”‚
â”‚      4. AddressRepo.GetAllAsync()                          â”‚
â”‚      5. CaseRepo.GetActiveCasesAsync()                     â”‚
â”‚      6. CreateFarmAssignmentOverviewDto() (internt)        â”‚
â”‚      7. Returnerer NatureCheckCaseAssignmentContext        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. REPOSITORY INTERFACES (Core.Abstract)                   â”‚
â”‚    Mappe: Abstract/                                          â”‚
â”‚    Interfaces: IFarmRepository, IPersonRepository,          â”‚
â”‚                IAddressRepository, INatureCheckCaseRepositoryâ”‚
â”‚    â†“ implementeret af                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. REPOSITORY IMPLEMENTATIONS (Infrastructure)              â”‚
â”‚    Mappe: Repositories/                                      â”‚
â”‚    Base: Repository<TEntity>                                 â”‚
â”‚    Concrete: FarmRepository, PersonRepository, etc.        â”‚
â”‚    Metoder: GetAllAsync(), GetPersonsByRoleAsync()          â”‚
â”‚    â†“ bruger                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. EF CORE LAYER                                            â”‚
â”‚    Mappe: Persistence/                                       â”‚
â”‚    Klasse: AppDbContext                                      â”‚
â”‚    DbSets: Farms, Persons, Addresses, NatureCheckCases    â”‚
â”‚    Metoder: GetAllAsync(), GetPersonsByRoleAsync()         â”‚
â”‚    â†“ genererer SQL                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. DATABASE (SQL Server)                                    â”‚
â”‚    Tabeller: FARMS, PERSONS, ADDRESSES,                    â”‚
â”‚              NATURE_CHECK_CASES, ROLES                      â”‚
â”‚    SQL: SELECT * FROM FARMS, etc.                          â”‚
â”‚    â†“ returnerer data                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
         (Samme vej tilbage gennem alle lag)
```

---

## ğŸ” Detaljeret Metode Flow

### Eksempel: IndlÃ¦s assignment context

```csharp
// 1. UI: Brugeren Ã¥bner siden
InitializeAsync();
//     â†‘ kalder

// 2. ViewModel: ArlaEmployeeAssignNatureCheckViewModel.InitializeAsync()
// (Faktisk kode - linje 291-294)

await EnsureAssignmentDataAsync();  // Faktisk metode (ikke direkte LoadAssignmentContextAsync som i SD'en)

// EnsureAssignmentDataAsync (linje 365-394)
if (_assignmentLoaded && !forceReload) return;  // Caching check (ikke i SD'en)

using IDisposable loading = _statusInfoServices.BeginLoadingOrSaving();  // Faktisk metode (ikke BeginLoading() som i SD'en)

try
{
    // Kalder Service (som i SD'en)
    NatureCheckCaseAssignmentContext context = await _natureCheckCaseService.LoadAssignmentContextAsync();
    //     â†‘ kalder via INatureCheckCaseService interface
    
    if (context == null)  // Validation (ikke i SD'en)
    {
        _appMessageService.AddErrorMessage("Kunne ikke hente data: context was null");
        return;
    }
    
    // Success path (som i SD'en)
    UpdateFarms(context.Farms);  // PrÃ¦cis som i SD'en
    UpdateConsultants(context.Consultants);  // PrÃ¦cis som i SD'en
    
    _assignmentLoaded = true;  // Caching flag (ikke i SD'en)
}
catch (Exception ex)  // Exception handling (ikke i SD'en)
{
    _appMessageService.AddErrorMessage($"Kunne ikke hente data: {ex.Message}");
    _assignmentLoaded = false;
}
// using statement kalder automatisk loading.Dispose() (som i SD'en)

// 3. Service: NatureCheckCaseService.LoadAssignmentContextAsync()
// (Faktisk kode - linje 53-85)

// Henter data fra repositories (prÃ¦cis som i SD'en - rÃ¦kkefÃ¸lge matcher)
List<Farm> farms = (await _farmRepository.GetAllAsync(cancellationToken)).ToList();  // Step 1 (linje 56)
List<Person> allPersons = (await _personRepository.GetAllAsync(cancellationToken)).ToList();  // Step 2 (linje 57)
List<Person> consultants = (await _personRepository.GetPersonsByRoleAsync(RoleName.Consultant.ToString(), cancellationToken)).ToList();  // Step 3 (linje 58)
List<Address> addresses = (await _addressRepository.GetAllAsync(cancellationToken)).ToList();  // Step 4 (linje 59)
IReadOnlyList<NatureCheckCase> activeCases = await _natureCheckCaseRepository.GetActiveCasesAsync(cancellationToken);  // Step 5 (linje 60)

// Opretter dictionaries (ikke i SD'en, men i koden)
Dictionary<Guid, Person> personsById = allPersons.ToDictionary(p => p.Id, p => p);  // Linje 62
Dictionary<Guid, Address> addressesById = addresses.ToDictionary(a => a.Id, a => a);  // Linje 63
HashSet<Guid> activeFarmIds = activeCases.Select(c => c.FarmId).ToHashSet();  // Linje 65-67
Dictionary<Guid, NatureCheckCase> activeCasesByFarm = activeCases
    .GroupBy(c => c.FarmId)
    .Select(g => g.OrderByDescending(c => c.AssignedAt ?? c.CreatedAt).First())
    .ToDictionary(c => c.FarmId, c => c);  // Linje 69-72

// Opretter DTOs (som CreateFarmAssignmentOverviewDto() i SD'en)
List<FarmAssignmentOverviewDto> overview = farms
    .Select(f => CreateFarmOverview(f, personsById, addressesById, activeFarmIds.Contains(f.Id), activeCasesByFarm))
    .OrderBy(f => f.FarmName)
    .ToList();  // Linje 74-77

// Sorterer konsulenter (ikke i SD'en, men i koden)
List<Person> sortedConsultants = consultants
    .OrderBy(c => c.FirstName)
    .ThenBy(c => c.LastName)
    .ToList();  // Linje 79-82

// Returnerer context (som i SD'en)
return new NatureCheckCaseAssignmentContext(overview, sortedConsultants);  // Linje 84

// 4. Repository: FarmRepository.GetAllAsync()
// (Arver fra base Repository<TEntity>)
// Bruger EF Core DbContext til at hente data
// EF Core genererer SQL: SELECT * FROM FARMS
// Database returnerer data
// EF Core mapper til Farm entities
// Repository returnerer List<Farm>

// 5. Samme for PersonRepository, AddressRepository, NatureCheckCaseRepository

// 6. Data flyder tilbage:
//    Service â†’ ViewModel â†’ UI
//    UI viser gÃ¥rde og konsulenter i dropdowns
```

---

## ğŸ§ª Relevante Tests

### Test 1: LoadAssignmentContextAsync_WithValidData_ReturnsContext
**Fil:** `tests/ArlaNatureConnect/TestCore/Services/NatureCheckCaseServiceTests.cs`  
**Linje:** 182-222

**Hvad tester den?**
- Tester at `LoadAssignmentContextAsync()` returnerer korrekt context med farms og consultants
- Verificerer at alle repository kald sker i korrekt rÃ¦kkefÃ¸lge
- Tester at DTOs oprettes korrekt

**Hvorfor er den god?**
- DÃ¦kker hovedflowet (happy path)
- Verificerer at alle repositories kaldes
- Tester at return type er korrekt

**Test struktur:**
```csharp
[TestMethod]
public async Task LoadAssignmentContextAsync_WithValidData_ReturnsContext()
{
    // ARRANGE
    // Setup mocks for alle repositories
    _farmRepositoryMock.Setup(r => r.GetAllAsync(cancellationToken)).ReturnsAsync(farms);
    _personRepositoryMock.Setup(r => r.GetAllAsync(cancellationToken)).ReturnsAsync(persons);
    _personRepositoryMock.Setup(r => r.GetPersonsByRoleAsync(...)).ReturnsAsync(consultants);
    _addressRepositoryMock.Setup(r => r.GetAllAsync(cancellationToken)).ReturnsAsync(addresses);
    _natureCheckCaseRepositoryMock.Setup(r => r.GetActiveCasesAsync(cancellationToken)).ReturnsAsync([]);

    // ACT
    NatureCheckCaseAssignmentContext result = await _service.LoadAssignmentContextAsync(cancellationToken);

    // ASSERT
    Assert.IsNotNull(result);
    Assert.HasCount(1, result.Farms);
    Assert.HasCount(1, result.Consultants);
}
```

---

### Test 2: InitializeAsync_WithValidData_LoadsAssignmentData
**Fil:** `tests/ArlaNatureConnect/TestWinUI/ViewModels/Pages/ArlaEmployeeAssignNatureCheckViewModelTests.cs`  
**Linje:** 138-168

**Hvad tester den?**
- Tester at `InitializeAsync()` kalder service og opdaterer ViewModel collections
- Verificerer at `UpdateFarms()` og `UpdateConsultants()` kaldes
- Tester at UI bindings opdateres korrekt

**Hvorfor er den god?**
- DÃ¦kker ViewModel laget
- Verificerer integration mellem ViewModel og Service
- Tester at collections opdateres korrekt

**Test struktur:**
```csharp
[TestMethod]
public async Task InitializeAsync_WithValidData_LoadsAssignmentData()
{
    // ARRANGE
    var context = new NatureCheckCaseAssignmentContext(farms, consultants);
    _serviceMock.Setup(s => s.LoadAssignmentContextAsync(It.IsAny<CancellationToken>()))
        .ReturnsAsync(context);

    // ACT
    await _viewModel.InitializeAsync();

    // ASSERT
    Assert.AreEqual(1, _viewModel.FilteredFarms.Count);
    Assert.AreEqual(1, _viewModel.Consultants.Count);
}
```

---

## ğŸ“ Noter

- **Caching:** ViewModel bruger `_assignmentLoaded` flag for at undgÃ¥ unÃ¸dvendige reloads. Dette er ikke vist i SD'en, men er vigtigt for performance.
- **Exception handling:** ViewModel hÃ¥ndterer exceptions og viser fejlbeskeder til brugeren. Dette er ikke vist i SD'en, men er vigtigt for robusthed.
- **Sorting:** Service sorterer farms alfabetisk og consultants efter fornavn/efternavn. Dette er ikke eksplicit vist i SD'en, men er vigtigt for UX.
- **DTO creation:** Service mapper entities til DTOs for at isolere ViewModel fra domain entities. Dette er vist i SD'en som `CreateFarmAssignmentOverviewDto()`.
