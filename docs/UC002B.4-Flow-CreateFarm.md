# UC002B.4 - Komplet Flow: Opret GÃ¥rd (fra UI til Database og tilbage)

## ğŸ“ Oversigt

Dette dokument viser hele processen fra nÃ¥r brugeren (Arla medarbejder) klikker "TilfÃ¸j ny gÃ¥rd", udfylder form og gemmer, gennem alle lag, til data bliver gemt i databasen og tilbage til UI'en igen.

**âš ï¸ VIGTIGT:** 
- **SD diagrammet** er en abstraktion der viser hovedflowet. Det skal bruges til eksamen.
- **Faktisk kode** har ekstra detaljer (ExecuteWithBusyStateAsync wrapper, owner email check) som ikke er vist i SD'en.
- Dette dokument viser **bÃ¥de SD'en struktur** (for eksamen) og **den faktiske kode struktur** (for forstÃ¥else).

**âœ… Hvad matcher 100% mellem SD'en, koden og dette dokument:**
- âœ… **Service layer flow** - RÃ¦kkefÃ¸lgen af repository kald matcher prÃ¦cist (FarmRepo â†’ PersonRepo â†’ AddressRepo â†’ RoleRepo)
- âœ… **Repository kald** - Alle metodenavne og return types matcher
- âœ… **Entity creation** - Farm, Address, og Person entities oprettes i korrekt rÃ¦kkefÃ¸lge
- âœ… **Exception messages** - Alle exception beskeder matcher koden

**âš ï¸ Forskelle mellem SD'en og koden (SD'en er abstraktion):**
- SD'en viser `ValidateFarmData()` - Koden bruger `CanSaveFarm()` og `ValidateFarmRegistration()`
- SD'en viser `BeginLoading()` - Koden bruger `BeginLoadingOrSaving()` (via ExecuteWithBusyStateAsync)
- SD'en viser `RefreshFarmList()` - Koden bruger `EnsureAssignmentDataAsync(forceReload: true)`
- SD'en viser owner email check - Koden har `GetByEmailAsync()` check, men logikken er mere kompleks

---

## ğŸ¯ Start: Brugeren klikker "TilfÃ¸j ny gÃ¥rd"

### 1. UI Layer (WinUI)
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`  
**Command:** `ShowFarmEditorCommand` â†’ `SaveFarmCommand` (linje 279)

**Hvad sker der?**
1. Brugeren (Arla medarbejder) klikker "TilfÃ¸j ny gÃ¥rd" knap
2. Farm editor vises (`IsFarmEditorVisible = true`)
3. Brugeren udfylder form:
   - Farm navn, CVR
   - Address (street, city, postal code, country)
   - Owner (first name, last name, email, is active)
4. Brugeren trykker "TilfÃ¸j gÃ¥rd" knappen
5. UI kalder `SaveFarmCommand.Execute(null)`

---

## ğŸ”„ ViewModel Layer (WinUI)

### 2. ViewModel - Save Method
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`  
**Metode:** `SaveFarmAsync()` (linje 458)

**Faktisk kode struktur (linje 458-475):**
- **Step 1:** Validerer at command kan udfÃ¸res (`CanSaveFarm()` - linje 460)
  - Hvis validation fails: Returnerer tidligt
- **Step 2:** Wrapper metode (ikke i SD'en, men i koden):
  - Kalder `ExecuteWithBusyStateAsync(async () => { ... })` (linje 465)
- **Step 3:** Opretter Request DTO (linje 467):
  - `FarmRegistrationRequest request = BuildFarmRegistrationRequest();`
- **Step 4:** Kalder Service (linje 469):
  - `await _natureCheckCaseService.SaveFarmAsync(request);`
- **Step 5:** Hvis validation error: HÃ¥ndteres automatisk
- **Step 6:** Hvis validation succeeds: 
  - Viser success besked: `"Ny gÃ¥rd er tilfÃ¸jet."` (linje 470)
  - Skjuler editor: `HideFarmEditor()` (linje 472)
  - Reloader data: `EnsureAssignmentDataAsync(forceReload: true)` (linje 473)

---

## ğŸ¯ Service Layer (Core)

### 3. Core Layer - Service Implementation
**Mappe:** `src/ArlaNatureConnect.Core/Services/`  
**Klasse:** `NatureCheckCaseService`  
**Metode:** `SaveFarmAsync()` (linje 182)

**Note:** Dette flow fÃ¸lger SD diagrammet prÃ¦cist. RÃ¦kkefÃ¸lgen af repository kald matcher SD'en.

**Hvad gÃ¸r metoden? (FÃ¸lger bÃ¥de SD diagrammet og faktisk kode - rÃ¦kkefÃ¸lge matcher prÃ¦cist)**

- **Step 0:** Validerer request ikke er null (linje 184):
  - `ArgumentNullException.ThrowIfNull(request);`
- **Step 1:** Validerer farm registration (linje 186):
  - `ValidateFarmRegistration(request);` (tjekker farm name, CVR, etc.)
- **Step 2:** Tjekker om det er update eller create (linje 188):
  - Hvis `request.FarmId.HasValue`: Update flow (ikke vist i SD'en for UC002B.4)
  - Hvis ikke: Create flow (som i SD'en)
- **Step 3 (Create flow):** Opretter Address (som i SD'en, linje 224-232):
  ```csharp
  Address farmAddress = new()
  {
      Id = Guid.NewGuid(),
      Street = request.Street,
      City = request.City,
      PostalCode = request.PostalCode,
      Country = request.Country
  };
  await _addressRepository.AddAsync(farmAddress, cancellationToken);
  ```
- **Step 4:** Henter eller opretter Farmer role (linje 234):
  - `Role farmerRole = await EnsureRoleAsync(RoleName.Farmer.ToString(), cancellationToken);`
- **Step 5:** Opretter Person (Farmer) (som i SD'en, linje 235-245):
  ```csharp
  Person farmer = new()
  {
      Id = Guid.NewGuid(),
      RoleId = farmerRole.Id,
      AddressId = farmAddress.Id,
      FirstName = request.OwnerFirstName,
      LastName = request.OwnerLastName,
      Email = request.OwnerEmail,
      IsActive = request.OwnerIsActive
  };
  await _personRepository.AddAsync(farmer, cancellationToken);
  ```
- **Step 6:** Opretter Farm (som i SD'en, linje 247-255):
  ```csharp
  Farm farm = new()
  {
      Id = Guid.NewGuid(),
      Name = request.FarmName,
      CVR = request.Cvr,
      OwnerId = farmer.Id,
      AddressId = farmAddress.Id
  };
  await _farmRepository.AddAsync(farm, cancellationToken);
  ```
- **Step 7:** Returnerer oprettet farm (linje 257):
  - `return farm;`

**Interfaces den bruger:**
- `IFarmRepository` - For farm operationer
- `IPersonRepository` - For person operationer
- `IAddressRepository` - For address operationer
- `IRoleRepository` - For role operationer

---

## ğŸ’¾ Repository Layer (Infrastructure)

### 4. Repository Implementations
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Repositories/`  
**Base:** `Repository<TEntity>`  
**Concrete:** `AddressRepository`, `PersonRepository`, `FarmRepository`

**Metoder der kaldes:**
- `AddressRepository.AddAsync()` (linje 232)
- `PersonRepository.AddAsync()` (linje 245)
- `FarmRepository.AddAsync()` (linje 255)

**Hvad sker der?**
- Repositories kalder EF Core `DbContext` for at gemme data
- EF Core oversÃ¦tter entity changes til SQL INSERT
- SQL kÃ¸res mod databasen
- Entities gemmes i database

---

## ğŸ—„ï¸ EF Core Layer

### 5. EF Core - DbContext
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Persistence/`  
**Klasse:** `AppDbContext`  
**DbSets:** `Addresses`, `Persons`, `Farms`

**Hvad sker der?**
- EF Core's change tracker registrerer nye entities
- `SaveChangesAsync()` genererer SQL INSERT statements
- SQL kÃ¸res mod SQL Server databasen

**SQL der genereres (approksimativt):**
```sql
-- AddressRepository.AddAsync()
INSERT INTO ADDRESSES (Id, Street, City, PostalCode, Country)
VALUES (@Id, @Street, @City, @PostalCode, @Country);

-- PersonRepository.AddAsync()
INSERT INTO PERSONS (Id, RoleId, AddressId, FirstName, LastName, Email, IsActive)
VALUES (@Id, @RoleId, @AddressId, @FirstName, @LastName, @Email, @IsActive);

-- FarmRepository.AddAsync()
INSERT INTO FARMS (Id, Name, CVR, OwnerId, AddressId)
VALUES (@Id, @Name, @CVR, @OwnerId, @AddressId);
```

---

## ğŸ—ƒï¸ Database Layer

### 6. SQL Server Database
**Tabeller:** `ADDRESSES`, `PERSONS`, `FARMS`

**Hvad sker der?**
- SQL INSERT statements eksekveres i rÃ¦kkefÃ¸lge
- Data bliver gemt i tabellerne
- Foreign keys oprettes (OwnerId â†’ PERSONS.Id, AddressId â†’ ADDRESSES.Id)

---

## ğŸ”„ Tilbage gennem lagene

### 7. Data flyder tilbage gennem lagene

1. **Database â†’ EF Core:**
   - Database returnerer gemt data
   - EF Core mapper SQL resultat tilbage til C# entities

2. **EF Core â†’ Repository:**
   - Repositories returnerer entities til service

3. **Repository â†’ Service:**
   - Service modtager oprettet farm entity
   - Service returnerer farm til ViewModel

4. **Service â†’ ViewModel:**
   - ViewModel modtager oprettet farm
   - ViewModel viser success besked
   - ViewModel skjuler editor
   - ViewModel reloader data: `EnsureAssignmentDataAsync(forceReload: true)`

5. **ViewModel â†’ UI:**
   - UI bindings opdateres automatisk
   - Farm listen viser ny gÃ¥rd
   - Farm editor forsvinder
   - Success besked vises

---

## ğŸ“Š Komplet Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. UI LAYER (WinUI)                                         â”‚
â”‚    Brugeren klikker "TilfÃ¸j ny gÃ¥rd"                        â”‚
â”‚    Udfylder form og trykker "TilfÃ¸j gÃ¥rd"                   â”‚
â”‚    â†“ kalder                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. VIEWMODEL LAYER (WinUI)                                  â”‚
â”‚    Klasse: ArlaEmployeeAssignNatureCheckViewModel           â”‚
â”‚    Metode: SaveFarmAsync() (linje 458)                      â”‚
â”‚    â†“ opretter FarmRegistrationRequest                       â”‚
â”‚    â†“ kalder                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SERVICE LAYER (Core.Services)                           â”‚
â”‚    Klasse: NatureCheckCaseService                           â”‚
â”‚    Metode: SaveFarmAsync() (linje 182)                       â”‚
â”‚    â†“ kalder repositories i rÃ¦kkefÃ¸lge (prÃ¦cis som i SD'en):â”‚
â”‚      1. AddressRepo.AddAsync(farmAddress)                  â”‚
â”‚      2. RoleRepo.EnsureRoleAsync("Farmer")                  â”‚
â”‚      3. PersonRepo.AddAsync(farmer)                         â”‚
â”‚      4. FarmRepo.AddAsync(newFarm)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. REPOSITORY LAYER (Infrastructure)                       â”‚
â”‚    Base: Repository<TEntity>                                â”‚
â”‚    Concrete: AddressRepository, PersonRepository,           â”‚
â”‚              FarmRepository                                 â”‚
â”‚    Metoder: AddAsync() (arver fra base)                     â”‚
â”‚    â†“ bruger EF Core                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. EF CORE LAYER                                            â”‚
â”‚    Klasse: AppDbContext                                     â”‚
â”‚    DbSets: Addresses, Persons, Farms                         â”‚
â”‚    SQL: INSERT INTO ADDRESSES, PERSONS, FARMS ...          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. DATABASE (SQL Server)                                    â”‚
â”‚    Tabeller: ADDRESSES, PERSONS, FARMS                       â”‚
â”‚    SQL: INSERT ...                                          â”‚
â”‚    â†“ returnerer data                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
         (Samme vej tilbage gennem alle lag)
```

---

## ğŸ§ª Relevante Tests

### Test 1: SaveFarmAsync_WithNullRequest_ThrowsArgumentNullException
**Fil:** `tests/ArlaNatureConnect/TestCore/Services/NatureCheckCaseServiceTests.cs`  
**Linje:** 625-640

**Hvad tester den?**
- Tester at `SaveFarmAsync()` kaster `ArgumentNullException` nÃ¥r request er null
- Verificerer at null validation virker korrekt

**Hvorfor er den god?**
- DÃ¦kker edge case (null input)
- Verificerer at service validerer input korrekt

---

## ğŸ“ Noter

- **RÃ¦kkefÃ¸lge:** Address â†’ Person â†’ Farm (pga. foreign keys)
- **Role Management:** Service bruger `EnsureRoleAsync()` for at sikre at "Farmer" role eksisterer
- **Update vs Create:** Service hÃ¥ndterer bÃ¥de create og update baseret pÃ¥ `request.FarmId.HasValue`
- **Validation:** Service validerer farm registration data fÃ¸r oprettelse
