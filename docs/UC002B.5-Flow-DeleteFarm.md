# UC002B.5 - Komplet Flow: Slet GÃ¥rd (fra UI til Database og tilbage)

## ğŸ“ Oversigt

Dette dokument viser hele processen fra nÃ¥r brugeren (Arla medarbejder) vÃ¦lger en gÃ¥rd, klikker "Slet gÃ¥rd", bekrÃ¦fter, gennem alle lag, til data bliver slettet fra databasen og tilbage til UI'en igen.

**âš ï¸ VIGTIGT:** 
- **SD diagrammet** er en abstraktion der viser hovedflowet. Det skal bruges til eksamen.
- **Faktisk kode** har ekstra detaljer (confirmation dialog, ExecuteWithBusyStateAsync wrapper) som ikke er vist i SD'en.
- Dette dokument viser **bÃ¥de SD'en struktur** (for eksamen) og **den faktiske kode struktur** (for forstÃ¥else).

**âœ… Hvad matcher 100% mellem SD'en, koden og dette dokument:**
- âœ… **Service layer flow** - RÃ¦kkefÃ¸lgen af repository kald matcher prÃ¦cist (CaseRepo â†’ FarmRepo)
- âœ… **Repository kald** - Alle metodenavne og return types matcher
- âœ… **Validation** - Tjek for aktive cases matcher
- âœ… **Exception messages** - Alle exception beskeder matcher koden

**âš ï¸ Forskelle mellem SD'en og koden (SD'en er abstraktion):**
- SD'en viser ikke confirmation dialog - Koden har `ContentDialogHelper.ShowConfirmationAsync()`
- SD'en viser `RefreshFarmList()` - Koden bruger `EnsureAssignmentDataAsync(forceReload: true)`
- SD'en viser ikke ExecuteWithBusyStateAsync wrapper - Koden bruger denne wrapper

---

## ğŸ¯ Start: Brugeren klikker "Slet gÃ¥rd"

### 1. UI Layer (WinUI)
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`  
**Command:** `DeleteFarmCommand` (linje 281)

**Hvad sker der?**
1. Brugeren (Arla medarbejder) vÃ¦lger en gÃ¥rd fra listen (`SelectedFarm`)
2. Brugeren klikker "Slet gÃ¥rd" knappen
3. UI kalder `DeleteFarmCommand.Execute(null)`

---

## ğŸ”„ ViewModel Layer (WinUI)

### 2. ViewModel - Delete Method
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`  
**Metode:** `DeleteSelectedFarmAsync()` (linje 477)

**Faktisk kode struktur (linje 477-502):**
- **Step 1:** Validerer at command kan udfÃ¸res (`CanDeleteFarm()` - linje 479)
  - Hvis validation fails: Returnerer tidligt
- **Step 2:** Viser confirmation dialog (ikke i SD'en, men i koden, linje 484-489):
  - `ContentDialogHelper.ShowConfirmationAsync(...)`
  - Hvis brugeren ikke bekrÃ¦fter: Returnerer tidligt
- **Step 3:** Wrapper metode (ikke i SD'en, men i koden):
  - Kalder `ExecuteWithBusyStateAsync(async () => { ... })` (linje 496)
- **Step 4:** Kalder Service (linje 498):
  - `await _natureCheckCaseService.DeleteFarmAsync(SelectedFarm!.FarmId);`
- **Step 5:** Hvis validation error: HÃ¥ndteres automatisk
- **Step 6:** Hvis validation succeeds: 
  - Viser success besked: `"{FarmName} er slettet."` (linje 499)
  - Reloader data: `EnsureAssignmentDataAsync(forceReload: true)` (linje 500)

---

## ğŸ¯ Service Layer (Core)

### 3. Core Layer - Service Implementation
**Mappe:** `src/ArlaNatureConnect.Core/Services/`  
**Klasse:** `NatureCheckCaseService`  
**Metode:** `DeleteFarmAsync()` (linje 261)

**Note:** Dette flow fÃ¸lger SD diagrammet prÃ¦cist. RÃ¦kkefÃ¸lgen af repository kald matcher SD'en.

**Hvad gÃ¸r metoden? (FÃ¸lger bÃ¥de SD diagrammet og faktisk kode - rÃ¦kkefÃ¸lge matcher prÃ¦cist)**

- **Step 1:** Henter farm: `await _farmRepository.GetByIdAsync(farmId, cancellationToken)` (linje 263)
  - Returnerer `Farm?` (nullable)
  - Hvis null: Returnerer tidligt (linje 264-267) - Farm eksisterer ikke, intet at slette
- **Step 2:** Tjekker om gÃ¥rd har aktiv case: `await _natureCheckCaseRepository.FarmHasActiveCaseAsync(farmId, cancellationToken)` (linje 269)
  - Returnerer `bool`
  - Hvis `true`: Kaster `InvalidOperationException("GÃ¥rden har aktive Natur Check opgaver og kan ikke slettes.")` (linje 270-273)
- **Step 3:** Hvis validation error: Service kaster Exception og returnerer til ViewModel
- **Step 4:** Hvis validation succeeds: Sletter farm (linje 275):
  - `await _farmRepository.DeleteAsync(farmId, cancellationToken);`
  - Returnerer `void`

**Interfaces den bruger:**
- `IFarmRepository` - For farm operationer
- `INatureCheckCaseRepository` - For case validation

---

## ğŸ’¾ Repository Layer (Infrastructure)

### 4. Repository Implementation
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Repositories/`  
**Base:** `Repository<Farm>`  
**Metode:** `DeleteAsync()` (arver fra base)

**Hvad sker der?**
- Repository kalder EF Core `DbContext` for at slette data
- EF Core oversÃ¦tter entity deletion til SQL DELETE
- SQL kÃ¸res mod databasen
- Farm slettes fra database (cascade delete hÃ¥ndterer relaterede data)

---

## ğŸ—„ï¸ EF Core Layer

### 5. EF Core - DbContext
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Persistence/`  
**Klasse:** `AppDbContext`  
**DbSet:** `Farms`

**Hvad sker der?**
- EF Core's change tracker registrerer entity deletion
- `SaveChangesAsync()` genererer SQL DELETE statement
- SQL kÃ¸res mod SQL Server databasen
- Cascade delete konfiguration hÃ¥ndterer relaterede data (addresses, cases)

**SQL der genereres (approksimativt):**
```sql
DELETE FROM FARMS
WHERE Id = @Id;
-- Cascade delete hÃ¥ndterer relaterede data (hvis konfigureret)
```

---

## ğŸ—ƒï¸ Database Layer

### 6. SQL Server Database
**Tabel:** `FARMS`

**Hvad sker der?**
- SQL DELETE statement eksekveres
- Farm bliver slettet fra tabellen
- Cascade delete hÃ¥ndterer relaterede data (hvis konfigureret)

---

## ğŸ”„ Tilbage gennem lagene

### 7. Data flyder tilbage gennem lagene

1. **Database â†’ EF Core:**
   - Database returnerer antal rÃ¦kker pÃ¥virket
   - EF Core bekrÃ¦fter deletion

2. **EF Core â†’ Repository:**
   - Repository returnerer `void` til service

3. **Repository â†’ Service:**
   - Service modtager bekrÃ¦ftelse
   - Service returnerer `void` til ViewModel

4. **Service â†’ ViewModel:**
   - ViewModel modtager bekrÃ¦ftelse
   - ViewModel viser success besked
   - ViewModel reloader data: `EnsureAssignmentDataAsync(forceReload: true)`

5. **ViewModel â†’ UI:**
   - UI bindings opdateres automatisk
   - Farm listen opdateres (slettet gÃ¥rd forsvinder)
   - Success besked vises

---

## ğŸ“Š Komplet Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. UI LAYER (WinUI)                                         â”‚
â”‚    Brugeren vÃ¦lger gÃ¥rd og klikker "Slet gÃ¥rd"              â”‚
â”‚    BekrÃ¦fter sletning                                        â”‚
â”‚    â†“ kalder                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. VIEWMODEL LAYER (WinUI)                                  â”‚
â”‚    Klasse: ArlaEmployeeAssignNatureCheckViewModel           â”‚
â”‚    Metode: DeleteSelectedFarmAsync() (linje 477)           â”‚
â”‚    â†“ kalder                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SERVICE LAYER (Core.Services)                           â”‚
â”‚    Klasse: NatureCheckCaseService                           â”‚
â”‚    Metode: DeleteFarmAsync() (linje 261)                    â”‚
â”‚    â†“ kalder repositories i rÃ¦kkefÃ¸lge (prÃ¦cis som i SD'en):â”‚
â”‚      1. FarmRepo.GetByIdAsync(farmId)                      â”‚
â”‚      2. CaseRepo.FarmHasActiveCaseAsync(farmId)            â”‚
â”‚      3. FarmRepo.DeleteAsync(farmId)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. REPOSITORY LAYER (Infrastructure)                       â”‚
â”‚    Base: Repository<Farm>                                    â”‚
â”‚    Metode: DeleteAsync() (arver fra base)                    â”‚
â”‚    â†“ bruger EF Core                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. EF CORE LAYER                                            â”‚
â”‚    Klasse: AppDbContext                                     â”‚
â”‚    DbSet: Farms                                             â”‚
â”‚    SQL: DELETE FROM FARMS ...                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. DATABASE (SQL Server)                                    â”‚
â”‚    Tabel: FARMS                                              â”‚
â”‚    SQL: DELETE ...                                          â”‚
â”‚    â†“ returnerer bekrÃ¦ftelse                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
         (Samme vej tilbage gennem alle lag)
```

---

## ğŸ§ª Relevante Tests

### Test 1: DeleteFarmAsync_WithNoActiveCases_DeletesFarm
**Fil:** `tests/ArlaNatureConnect/TestCore/Services/NatureCheckCaseServiceTests.cs`  
**Linje:** 813-833

**Hvad tester den?**
- Tester at `DeleteFarmAsync()` sletter farm nÃ¥r ingen aktive cases eksisterer
- Verificerer at alle repository kald sker i korrekt rÃ¦kkefÃ¸lge
- Tester happy path scenarie

**Hvorfor er den god?**
- DÃ¦kker hovedflowet (happy path)
- Verificerer at farm bliver slettet korrekt
- Tester at validation virker (ingen aktive cases)

### Test 2: DeleteFarmAsync_WhenFarmHasActiveCases_ThrowsInvalidOperationException
**Fil:** `tests/ArlaNatureConnect/TestCore/Services/NatureCheckCaseServiceTests.cs`  
**Linje:** 860-876

**Hvad tester den?**
- Tester at `DeleteFarmAsync()` kaster exception nÃ¥r farm har aktive cases
- Verificerer at business rule bliver hÃ¥ndteret korrekt
- Tester edge case scenarie

**Hvorfor er den god?**
- DÃ¦kker edge case (farm har aktive cases)
- Verificerer at business rule virker
- Sikrer at farms med aktive cases ikke kan slettes

---

## ğŸ“ Noter

- **Business Rule:** Farms med aktive cases kan ikke slettes
- **Cascade Delete:** EF Core konfiguration hÃ¥ndterer relaterede data (addresses, cases)
- **Confirmation Dialog:** UI viser confirmation dialog fÃ¸r sletning (ikke vist i SD'en)
- **Silent Return:** Hvis farm ikke eksisterer, returnerer service stille (ingen exception)
