## Relational Database Schema – UC002B.2: Assign Nature Check Case to Consultant

This schema builds upon UC002B.1 and adds tables and constraints for case assignment operations.

---
### **Normalization**

| Normal form | Status | Explanation |
|--------------|---------|-------------|
| **1NF** | ✅ | All attributes are atomic |
| **2NF** | ✅ | All non-key attributes depend on the whole primary key |
| **3NF** | ✅ | No transitive dependencies – each entity has its own table |

---

### **Compact Notation**

|Notation|
|---------------------------------------------|
|NATURE_CHECK_CASES(CaseID PK, FarmID FK, ConsultantID FK, AssignedByPersonID FK, Status, Notes, Priority, CreatedAt, AssignedAt)|
|NOTIFICATIONS(NotificationID PK, CaseID FK, ConsultantID FK, CreatedAt, IsRead)|

---

### **NATURE_CHECK_CASES** (from UC002B.1)

| Attribute | Data type | Key | Description |
|------------|------------|-----|-------------|
| **Id** | `uniqueidentifier` | **PK** | Unique identifier for each Nature Check Case |
| **FarmId** | `uniqueidentifier` | **FK → Farms(Id)** | Reference to the farm for which the case is created |
| **ConsultantId** | `uniqueidentifier` | **FK → Persons(Id)** | Reference to the consultant assigned to the case (must have Consultant role) |
| **AssignedByPersonId** | `uniqueidentifier` | **FK → Persons(Id)** | Reference to the Arla employee who assigned the case (must have Employee role) |
| **Status** | `nvarchar(50)` |  | Current status of the case (e.g., "Assigned", "InProgress", "Completed", "Cancelled") |
| **Notes** | `nvarchar(MAX)` *(nullable)* |  | Optional internal notes about the case (batch, priority, comments) |
| **Priority** | `nvarchar(50)` *(nullable)* |  | Optional priority level of the case (e.g., "Low", "Medium", "High", "Urgent") |
| **CreatedAt** | `datetime2` |  | Timestamp of when the case was created (UTC) |
| **AssignedAt** | `datetime2` *(nullable)* |  | Timestamp of when the case was assigned to the consultant (UTC) |
| **RowVersion** | `rowversion` |  | For optimistic concurrency control |

---

### **NOTIFICATIONS** (New for UC002B.2)

| Attribute | Data type | Key | Description |
|------------|------------|-----|-------------|
| **Id** | `uniqueidentifier` | **PK** | Unique identifier for each notification |
| **CaseId** | `uniqueidentifier` | **FK → NatureCheckCases(Id)** | Reference to the Nature Check Case that triggered the notification |
| **ConsultantId** | `uniqueidentifier` | **FK → Persons(Id)** | Reference to the consultant who receives the notification |
| **CreatedAt** | `datetime2` |  | Timestamp of when the notification was created (UTC) |
| **IsRead** | `bit` |  | Whether the consultant has read the notification (default: 0) |

---

### **Relationships**

| Relation | Cardinality | Description |
|-----------|--------------|-------------|
| `FARMS` → `NATURE_CHECK_CASES` | **1 : 0..*** | One farm can have zero or more Nature Check Cases |
| `PERSONS` → `NATURE_CHECK_CASES` (ConsultantId) | **1 : 0..*** | One consultant can be assigned to zero or more Nature Check Cases |
| `PERSONS` → `NATURE_CHECK_CASES` (AssignedByPersonId) | **1 : 0..*** | One Arla employee can assign zero or more Nature Check Cases |
| `NATURE_CHECK_CASES` → `NOTIFICATIONS` | **1 : 1** | One case generates exactly one notification when assigned |
| `PERSONS` → `NOTIFICATIONS` (ConsultantId) | **1 : 0..*** | One consultant can receive zero or more notifications |

---

### **Constraints**

- **Primary Keys**: 
  - `NatureCheckCases.Id`
  - `Notifications.Id`
- **Foreign Keys**:
  - `NatureCheckCases.FarmId` references `Farms.Id` (ON DELETE CASCADE)
  - `NatureCheckCases.ConsultantId` references `Persons.Id` (ON DELETE NO ACTION)
  - `NatureCheckCases.AssignedByPersonId` references `Persons.Id` (ON DELETE NO ACTION)
  - `Notifications.CaseId` references `NatureCheckCases.Id` (ON DELETE CASCADE)
  - `Notifications.ConsultantId` references `Persons.Id` (ON DELETE CASCADE)
- **Check Constraints**:
  - `CK_NatureCheckCases_Status`: Status must be one of: "Assigned", "InProgress", "Completed", "Cancelled"
  - `CK_NatureCheckCases_Priority`: Priority must be NULL or one of: "Low", "Medium", "High", "Urgent"
- **Indexes** (from UC002B.1):
  - `IX_NatureCheckCases_FarmId`
  - `IX_NatureCheckCases_ConsultantId`
  - `IX_NatureCheckCases_Status`
  - `IX_NatureCheckCases_CreatedAt`
  - **New for UC002B.2:**
  - `IX_Notifications_ConsultantId` - For efficient notification queries by consultant
  - `IX_Notifications_CaseId` - For efficient case lookups
  - `IX_Notifications_IsRead` - For filtering unread notifications

---

### **Business Rules**

1. A `ConsultantId` must reference a `Person` with the role "Consultant"
2. An `AssignedByPersonId` must reference a `Person` with the role "Employee"
3. `Status` should be one of: "Assigned", "InProgress", "Completed", "Cancelled"
4. `CreatedAt` is automatically set to `SYSUTCDATETIME()` when the case is created
5. `AssignedAt` is set when the case is assigned (can be the same as `CreatedAt` for immediate assignment)
6. **New for UC002B.2:** A farm cannot have multiple active cases (status "Assigned" or "InProgress") at the same time
7. **New for UC002B.2:** When a case is assigned, a notification is automatically created for the consultant
8. **New for UC002B.2:** Priority must be stored in English format ("Low", "Medium", "High", "Urgent") even though UI displays Danish

---

### **Views** (from UC002B.1)

- `vw_FarmAssignmentOverview` - Aggregates farm data with assignment status
- `vw_ConsultantsList` - Provides sorted list of consultants

---

### **Stored Procedures** (from UC002B.1)

- `usp_GetFarmAssignmentOverview` - Retrieves all farms with assignment status
- `usp_GetConsultantsByRole` - Retrieves persons by role
- `usp_GetFarmAssignmentStatus` - Gets assignment status for a specific farm

**New Stored Procedures for UC002B.2:**
- `usp_NatureCheckCase_Insert` - Creates a new Nature Check Case
- `usp_Notification_Insert` - Creates a notification for a consultant
- `usp_CheckFarmHasActiveCase` - Checks if farm has active case before assignment


