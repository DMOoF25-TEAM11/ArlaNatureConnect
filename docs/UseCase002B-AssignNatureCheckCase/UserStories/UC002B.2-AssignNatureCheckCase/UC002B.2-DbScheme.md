## Relational Database Schema – UC002B.2: Assign Nature Check Case to Consultant

This schema builds upon UC002B.1 and adds tables and constraints for case assignment operations.

---
### **Normalization**

| Normal form | Status | Explanation |
|--------------|---------|-------------|
| **1NF** | ✅ | All attributes are atomic |
| **2NF** | ✅ | All non-key attributes depend on the whole primary key |
| **3NF** | ✅ | No transitive dependencies – each entity has its own table |

---

### **Compact Notation**

|Notation|
|---------------------------------------------|
|NATURE_CHECK_CASES(CaseID PK, FarmID FK, ConsultantID FK, AssignedByPersonID FK, Status, Notes, Priority, CreatedAt, AssignedAt)|

**Note:** In Entity Framework Core implementation, there is **NO separate NOTIFICATIONS table**. Notifications are generated from `NatureCheckCase` data in the service layer.

---

### **NATURE_CHECK_CASES** (from UC002B.1)

| Attribute | Data type | Key | Description |
|------------|------------|-----|-------------|
| **Id** | `uniqueidentifier` | **PK** | Unique identifier for each Nature Check Case |
| **FarmId** | `uniqueidentifier` | **FK → Farms(Id)** | Reference to the farm for which the case is created |
| **ConsultantId** | `uniqueidentifier` | **FK → Persons(Id)** | Reference to the consultant assigned to the case (must have Consultant role) |
| **AssignedByPersonId** | `uniqueidentifier` | **FK → Persons(Id)** | Reference to the Arla employee who assigned the case (must have Employee role) |
| **Status** | `nvarchar(50)` |  | Current status of the case (e.g., "Assigned", "InProgress", "Completed", "Cancelled") |
| **Notes** | `nvarchar(MAX)` *(nullable)* |  | Optional internal notes about the case (batch, priority, comments) |
| **Priority** | `nvarchar(50)` *(nullable)* |  | Optional priority level of the case (e.g., "Low", "Medium", "High", "Urgent") |
| **CreatedAt** | `datetime2` |  | Timestamp of when the case was created (UTC) |
| **AssignedAt** | `datetime2` *(nullable)* |  | Timestamp of when the case was assigned to the consultant (UTC) |
| **RowVersion** | `rowversion` |  | For optimistic concurrency control |

---

### **NOTIFICATIONS** (Not a Database Table in EF Implementation)

**In Entity Framework Core implementation:**
- Notifications are **NOT stored in a database table**
- Notifications are **generated from NatureCheckCase entities** in the service layer
- Returned as `ConsultantNotificationDto` objects (in-memory DTOs)
- Created by querying `NatureCheckCases` where `ConsultantId` matches and `Status = Assigned`

**Service Method:** `NatureCheckCaseService.GetNotificationsForConsultantAsync()`
- Queries NatureCheckCases for consultant
- Loads related Farm entities
- Converts to ConsultantNotificationDto objects
- Returns DTOs sorted by AssignedAt date

---

### **Relationships**

| Relation | Cardinality | Description |
|-----------|--------------|-------------|
| `FARMS` → `NATURE_CHECK_CASES` | **1 : 0..*** | One farm can have zero or more Nature Check Cases |
| `PERSONS` → `NATURE_CHECK_CASES` (ConsultantId) | **1 : 0..*** | One consultant can be assigned to zero or more Nature Check Cases |
| `PERSONS` → `NATURE_CHECK_CASES` (AssignedByPersonId) | **1 : 0..*** | One Arla employee can assign zero or more Nature Check Cases |

**Note:** Notifications are not stored in database. They are generated from NatureCheckCase data when consultant views them.

---

### **Constraints**

- **Primary Keys**: 
  - `NatureCheckCases.Id`
- **Foreign Keys**:
  - `NatureCheckCases.FarmId` references `Farms.Id` (ON DELETE CASCADE)
  - `NatureCheckCases.ConsultantId` references `Persons.Id` (ON DELETE NO ACTION)
  - `NatureCheckCases.AssignedByPersonId` references `Persons.Id` (ON DELETE NO ACTION)

**Note:** No foreign keys for Notifications table since it doesn't exist in EF implementation.
- **Check Constraints**:
  - `CK_NatureCheckCases_Status`: Status must be one of: "Assigned", "InProgress", "Completed", "Cancelled"
  - `CK_NatureCheckCases_Priority`: Priority must be NULL or one of: "Low", "Medium", "High", "Urgent"
- **Indexes** (from UC002B.1):
  - `IX_NatureCheckCases_FarmId`
  - `IX_NatureCheckCases_ConsultantId`
  - `IX_NatureCheckCases_Status`
  - `IX_NatureCheckCases_CreatedAt`

**Note:** No indexes for Notifications table since it doesn't exist. Notification queries use existing indexes on NatureCheckCases table.

---

### **Business Rules**

1. A `ConsultantId` must reference a `Person` with the role "Consultant"
2. An `AssignedByPersonId` must reference a `Person` with the role "Employee"
3. `Status` should be one of: "Assigned", "InProgress", "Completed", "Cancelled"
4. `CreatedAt` is automatically set to `SYSUTCDATETIME()` when the case is created
5. `AssignedAt` is set when the case is assigned (can be the same as `CreatedAt` for immediate assignment)
6. **New for UC002B.2:** A farm cannot have multiple active cases (status "Assigned" or "InProgress") at the same time
7. **New for UC002B.2:** When a case is assigned, notifications are generated from the case data when consultant views them (not stored in database)
8. **New for UC002B.2:** Priority must be stored in English format ("Low", "Medium", "High", "Urgent") even though UI displays Danish

---

### **Entity Framework Core Implementation**

**Note:** In Entity Framework Core implementation, views and stored procedures are replaced by:

- **LINQ queries** in repositories (e.g., `INatureCheckCaseRepository.GetActiveCasesAsync()`)
- **DTOs** created in service layer (e.g., `FarmAssignmentOverviewDto`, `ConsultantNotificationDto`)
- **In-memory processing** for aggregations and transformations

**Repository Methods Used:**
- `IFarmRepository.GetByIdAsync()` - Validates farm exists
- `IPersonRepository.GetByIdAsync()` - Validates consultant exists
- `IRoleRepository.GetByIdAsync()` - Validates consultant role
- `INatureCheckCaseRepository.FarmHasActiveCaseAsync()` - Checks for duplicate active cases
- `INatureCheckCaseRepository.AddAsync()` - Creates new case

**Service Methods:**
- `NatureCheckCaseService.AssignCaseAsync()` - Orchestrates case creation
- `NatureCheckCaseService.GetNotificationsForConsultantAsync()` - Generates notifications from case data

**No stored procedures or views needed** - all data access through EF Core repositories.


