## UC002B.2 – Sequence Diagram: Assign Nature Check Case to Consultant

This sequence diagram shows the detailed interaction flow when an Arla employee assigns a Nature Check Case to a consultant, following Larmann's UML conventions.

```mermaid
sequenceDiagram
    title UC002B.2 – Sequence Diagram: Assign Nature Check Case to Consultant

    actor ArlaEmployee as Arla Employee
    participant ViewModel as ArlaEmployeeAssignNatureCheckViewModel
    participant Service as NatureCheckCaseService
    participant FarmRepo as IFarmRepository
    participant PersonRepo as IPersonRepository
    participant CaseRepo as INatureCheckCaseRepository
    participant RoleRepo as IRoleRepository
    participant NotificationRepo as INotificationRepository
    participant MsgService as IAppMessageService
    participant StatusService as IStatusInfoServices

    %% Assignment Flow
    ArlaEmployee ->> ViewModel: Select consultant, priority, enter notes, click "Lav natur Check opgave"
    ViewModel ->> ViewModel: Validate selection (farm and consultant selected)
    
    alt Validation fails
        ViewModel ->> MsgService: AddErrorMessage("Vælg gård og konsulent")
        ViewModel -->> ArlaEmployee: Display error message
    else Validation succeeds
        ViewModel ->> StatusService: BeginLoading()
        ViewModel ->> Service: AssignCaseAsync(NatureCheckCaseAssignmentRequest)
        
        %% Service validates and creates case
        Service ->> FarmRepo: GetByIdAsync(request.FarmId)
        FarmRepo -->> Service: Farm?
        
        alt Farm not found
            Service -->> ViewModel: InvalidOperationException("Gården findes ikke")
            ViewModel ->> MsgService: AddErrorMessage(...)
            ViewModel -->> ArlaEmployee: Display error message
        else Farm found
            Service ->> PersonRepo: GetByIdAsync(request.ConsultantId)
            PersonRepo -->> Service: Person? (Consultant)
            
            alt Consultant not found
                Service -->> ViewModel: InvalidOperationException("Konsulent findes ikke")
                ViewModel ->> MsgService: AddErrorMessage(...)
                ViewModel -->> ArlaEmployee: Display error message
            else Consultant found
                Service ->> RoleRepo: GetByIdAsync(consultant.RoleId)
                RoleRepo -->> Service: Role?
                
                alt Consultant does not have Consultant role
                    Service -->> ViewModel: InvalidOperationException("Person har ikke konsulent-rollen")
                    ViewModel ->> MsgService: AddErrorMessage(...)
                    ViewModel -->> ArlaEmployee: Display error message
                else Consultant has correct role
                    Service ->> CaseRepo: FarmHasActiveCaseAsync(farmId)
                    CaseRepo -->> Service: bool
                    
                    alt Farm has active case
                        Service -->> ViewModel: InvalidOperationException("Gården har allerede en aktiv opgave")
                        ViewModel ->> MsgService: AddErrorMessage(...)
                        ViewModel -->> ArlaEmployee: Display error message
                    else No active case
                        %% Create new case
                        Service ->> Service: Create NatureCheckCase entity
                        Note over Service: Status = Assigned<br/>Priority = ConvertToEnglish(request.Priority)<br/>Notes = request.Notes<br/>CreatedAt = DateTimeOffset.UtcNow<br/>AssignedAt = DateTimeOffset.UtcNow
                        Service ->> CaseRepo: AddAsync(natureCheckCase)
                        CaseRepo -->> Service: NatureCheckCase (created)
                        
                        %% Create notification
                        Service ->> NotificationRepo: CreateNotificationAsync(caseId, consultantId)
                        NotificationRepo -->> Service: Notification (created)
                        
                        Service -->> ViewModel: NatureCheckCase (created entity)
                        ViewModel ->> MsgService: AddInfoMessage("Natur Check opgave er oprettet for [FarmName]")
                        ViewModel ->> ViewModel: Refresh farm list (reload data)
                        ViewModel ->> StatusService: Dispose loading
                        ViewModel -->> ArlaEmployee: Display success message and updated list
                    end
                end
            end
        end
    end
```

**Notes:**
- The service validates all inputs before creating the case.
- Priority is converted from Danish (UI) to English (database) in the service layer.
- A notification is automatically created when the case is assigned.
- The farm list is refreshed to show the updated assignment status.


