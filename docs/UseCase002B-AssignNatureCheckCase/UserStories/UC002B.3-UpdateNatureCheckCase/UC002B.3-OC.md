# Operation Contracts – UC002B.3: Update Nature Check Case Assignment

---

## **Operation Contract – UC002B.3: Update Nature Check Case**

| Item | Description |
|------|-------------|
| **Operation** | Update an existing active Nature Check Case for a farm with new consultant, priority, and notes. The system validates the update and updates the case information. |
| **Cross References** | UC002B.3 – Update Nature Check Case Assignment<br/>UC002B-SSD: Steps 8-9 (update flow)<br/>UC002B-SD: Update sequence |
| **Preconditions** | • The selected farm exists in the system.<br>• The farm has an active Nature Check Case (status "Assigned" or "InProgress").<br>• The selected person exists in the system and has the Consultant role (if consultant is being changed).<br>• The Arla employee updating the case is authenticated.<br>• If a priority is selected, it is a valid priority level.<br>• The RowVersion matches the current database state (no concurrent modification). |
| **Postconditions** | • The existing active Nature Check Case is updated with the following properties:<br>  - The case is reassigned to the selected consultant (if changed)<br>  - The case priority is updated (if changed)<br>  - The case notes are updated (if changed)<br>  - The case assignment time is updated to reflect the modification<br>  - The RowVersion is updated<br>• The farm's assignment status remains "Tilføjet" (Assigned).<br>• If consultant changed, a new notification is created for the new consultant.<br>• If consultant changed, the old consultant's notification is marked as read or removed.<br>• The Arla employee sees a success confirmation message: "Natur Check opgave er opdateret for [FarmName]." |
| **Input** | • Case ID<br>• Farm ID<br>• Consultant ID (if changed)<br>• Assigned By Person ID<br>• Priority (optional, Danish format from UI)<br>• Notes (optional)<br>• RowVersion (for optimistic concurrency) |
| **Output** | • Updated Nature Check Case entity<br>• Success confirmation message |
| **Exceptions** | • `InvalidOperationException` if farm has no active case<br>• `InvalidOperationException` if consultant does not have Consultant role<br>• `DbUpdateConcurrencyException` if RowVersion mismatch (concurrent modification)<br>• `ArgumentException` if priority format is invalid<br>• `NotFoundException` if farm, case, or consultant does not exist |

---

## **Operation Contract – UC002B.3: Get Active Case for Farm**

| Item | Description |
|------|-------------|
| **Operation** | Retrieve the active Nature Check Case for a specific farm to populate the update form. |
| **Cross References** | UC002B.3 – Update Nature Check Case Assignment |
| **Preconditions** | • The farm exists in the system. |
| **Postconditions** | • Active case is retrieved (if exists).<br>• Case data is returned for form population. |
| **Input** | • Farm ID |
| **Output** | • Nature Check Case entity (if active case exists)<br>• Null if no active case exists |
| **Exceptions** | • `NotFoundException` if farm does not exist |

---

## **Operation Contract – UC002B.3: Check Concurrent Modification**

| Item | Description |
|------|-------------|
| **Operation** | Check if the case has been modified by another user since it was loaded (using RowVersion). |
| **Cross References** | UC002B.3 – Update Nature Check Case Assignment |
| **Preconditions** | • The case exists in the system. |
| **Postconditions** | • Concurrent modification status is determined. |
| **Input** | • Case ID<br>• Expected RowVersion |
| **Output** | • Boolean indicating if RowVersion matches (no concurrent modification) |
| **Exceptions** | • `NotFoundException` if case does not exist |

---

## **Operation Contract – UC002B.3: Update Notification on Consultant Change**

| Item | Description |
|------|-------------|
| **Operation** | Create a new notification for the new consultant and manage the old consultant's notification when consultant is changed. |
| **Cross References** | UC002B.3 – Update Nature Check Case Assignment |
| **Preconditions** | • A Nature Check Case has been updated with a new consultant.<br>• The old and new consultants exist in the system. |
| **Postconditions** | • A new notification is created for the new consultant.<br>• The old consultant's notification is marked as read or removed. |
| **Input** | • Case ID<br>• Old Consultant ID<br>• New Consultant ID |
| **Output** | • Created Notification entity (for new consultant) |
| **Exceptions** | • `NotFoundException` if case or consultants do not exist |


