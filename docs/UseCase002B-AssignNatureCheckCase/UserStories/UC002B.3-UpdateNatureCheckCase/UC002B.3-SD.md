## UC002B.3 – Sequence Diagram: Update Nature Check Case Assignment

This sequence diagram shows the detailed interaction flow when an Arla employee updates a Nature Check Case assignment, following Larmann's UML conventions.

```mermaid
sequenceDiagram
    title UC002B.3 – Sequence Diagram: Update Nature Check Case Assignment

    actor ArlaEmployee as Arla Employee
    participant ViewModel as ArlaEmployeeAssignNatureCheckViewModel
    participant Service as NatureCheckCaseService
    participant FarmRepo as IFarmRepository
    participant PersonRepo as IPersonRepository
    participant CaseRepo as INatureCheckCaseRepository
    participant RoleRepo as IRoleRepository
    participant NotificationRepo as INotificationRepository
    participant MsgService as IAppMessageService
    participant StatusService as IStatusInfoServices

    %% Update Flow
    ArlaEmployee ->> ViewModel: Select farm with active case
    ViewModel ->> Service: GetActiveCaseForFarmAsync(farmId)
    Service ->> CaseRepo: GetActiveCaseForFarmAsync(farmId)
    CaseRepo -->> Service: NatureCheckCase?
    
    alt Active case found
        Service -->> ViewModel: NatureCheckCase (with existing data)
        ViewModel ->> ViewModel: Auto-populate form with existing assignment data
        Note over ViewModel: Consultant = existing consultant<br/>Priority = ConvertToDanish(existing.Priority)<br/>Notes = existing notes<br/>Button text = "Opdater natur Check opgave"
        ViewModel -->> ArlaEmployee: Display farm details and form
    else No active case
        ViewModel ->> MsgService: AddErrorMessage("Gården har ingen aktiv opgave")
        ViewModel -->> ArlaEmployee: Display error message
    end
    
    ArlaEmployee ->> ViewModel: Modify consultant, priority, notes, click "Opdater natur Check opgave"
    ViewModel ->> ViewModel: Validate selection (farm and consultant selected)
    
    alt Validation fails
        ViewModel ->> MsgService: AddErrorMessage("Vælg gård og konsulent")
        ViewModel -->> ArlaEmployee: Display error message
    else Validation succeeds
        ViewModel ->> StatusService: BeginLoading()
        ViewModel ->> Service: UpdateCaseAsync(farmId, NatureCheckCaseAssignmentRequest)
        
        %% Service validates and updates case
        Service ->> CaseRepo: GetActiveCaseForFarmAsync(farmId)
        CaseRepo -->> Service: NatureCheckCase?
        
        alt Active case not found
            Service -->> ViewModel: InvalidOperationException("Der findes ingen aktiv opgave")
            ViewModel ->> MsgService: AddErrorMessage(...)
            ViewModel -->> ArlaEmployee: Display error message
        else Active case found
            %% Check RowVersion for concurrent modification
            Service ->> Service: CheckRowVersion(request.RowVersion, existingCase.RowVersion)
            
            alt RowVersion mismatch (concurrent modification)
                Service -->> ViewModel: DbUpdateConcurrencyException("Opgaven er blevet ændret af en anden bruger")
                ViewModel ->> MsgService: AddErrorMessage(...)
                ViewModel -->> ArlaEmployee: Display error message
            else RowVersion matches
                Service ->> PersonRepo: GetByIdAsync(request.ConsultantId)
                PersonRepo -->> Service: Person? (Consultant)
                
                alt Consultant not found
                    Service -->> ViewModel: InvalidOperationException("Konsulent findes ikke")
                    ViewModel ->> MsgService: AddErrorMessage(...)
                    ViewModel -->> ArlaEmployee: Display error message
                else Consultant found
                    Service ->> RoleRepo: GetByIdAsync(consultant.RoleId)
                    RoleRepo -->> Service: Role?
                    
                    alt Consultant does not have Consultant role
                        Service -->> ViewModel: InvalidOperationException("Person har ikke konsulent-rollen")
                        ViewModel ->> MsgService: AddErrorMessage(...)
                        ViewModel -->> ArlaEmployee: Display error message
                    else Consultant has correct role
                        %% Check if consultant changed
                        Service ->> Service: ConsultantChanged = (existingCase.ConsultantId != request.ConsultantId)
                        
                        %% Update existing case
                        Service ->> Service: Update NatureCheckCase entity
                        Note over Service: ConsultantId = request.ConsultantId<br/>Priority = ConvertToEnglish(request.Priority)<br/>Notes = request.Notes<br/>AssignedAt = DateTimeOffset.UtcNow<br/>RowVersion = updated
                        Service ->> CaseRepo: UpdateAsync(existingCase)
                        CaseRepo -->> Service: Task completed
                        
                        alt Consultant changed
                            %% Create notification for new consultant
                            Service ->> NotificationRepo: CreateNotificationAsync(caseId, newConsultantId)
                            NotificationRepo -->> Service: Notification (created)
                            
                            %% Mark old consultant's notification as read
                            Service ->> NotificationRepo: MarkNotificationAsReadAsync(caseId, oldConsultantId)
                            NotificationRepo -->> Service: Task completed
                        end
                        
                        Service -->> ViewModel: NatureCheckCase (updated entity)
                        ViewModel ->> MsgService: AddInfoMessage("Natur Check opgave er opdateret for [FarmName]")
                        ViewModel ->> ViewModel: Refresh farm list (reload data)
                        ViewModel ->> StatusService: Dispose loading
                        ViewModel -->> ArlaEmployee: Display success message and updated list
                    end
                end
            end
        end
    end
```

**Notes:**
- The service validates all inputs and checks for concurrent modifications using RowVersion.
- Priority is converted from Danish (UI) to English (database) in the service layer.
- If consultant changed, a new notification is created and the old one is marked as read.
- The assignment timestamp is updated to reflect when the case was last modified.


