## UC002B.3 – Sequence Diagram: Update Nature Check Case Assignment

This sequence diagram shows the detailed interaction flow when an Arla employee updates a Nature Check Case assignment, following Larmann's UML conventions.

```mermaid
sequenceDiagram
    title UC002B.3 – Sequence Diagram: Update Nature Check Case Assignment

    actor ArlaEmployee as Arla Employee
    participant ViewModel as ArlaEmployeeAssignNatureCheckViewModel
    participant Service as NatureCheckCaseService
    participant PersonRepo as IPersonRepository
    participant CaseRepo as INatureCheckCaseRepository
    participant RoleRepo as IRoleRepository
    participant MsgService as IAppMessageService
    participant StatusService as IStatusInfoServices

    ArlaEmployee ->>+ ViewModel: SelectFarm(farmId)
    ViewModel ->>+ Service: GetActiveCaseForFarmAsync(farmId)
    Service ->>+ CaseRepo: GetActiveCaseForFarmAsync(farmId)
    CaseRepo -->>- Service: NatureCheckCase?
    
    alt Active case found
        Service -->>- ViewModel: NatureCheckCase
        ViewModel ->>+ ViewModel: PopulateFormWithCaseData()
        ViewModel -->>- ViewModel: void
        ViewModel -->>- ArlaEmployee: void
    else No active case
        Service -->>- ViewModel: null
        ViewModel ->>+ MsgService: AddErrorMessage("Gården har ingen aktiv opgave")
        MsgService -->>- ViewModel: void
        ViewModel -->>- ArlaEmployee: void
    end
    
    ArlaEmployee ->>+ ViewModel: UpdateNatureCheckCaseAsync()
    
    alt Validation fails
        ViewModel ->>+ MsgService: AddErrorMessage("Vælg gård og konsulent")
        MsgService -->>- ViewModel: void
        ViewModel -->> ArlaEmployee: void
    else Validation succeeds
        ViewModel ->>+ StatusService: BeginLoading()
        StatusService -->>- ViewModel: IDisposable
        ViewModel ->>+ Service: UpdateCaseAsync(farmId, request)
        
        Service ->>+ CaseRepo: GetActiveCaseForFarmAsync(farmId)
        CaseRepo -->>- Service: NatureCheckCase?
        Service ->>+ Service: CheckRowVersion(request.RowVersion, existingCase.RowVersion)
        Service -->>- Service: bool
        Service ->>+ PersonRepo: GetByIdAsync(request.ConsultantId)
        PersonRepo -->>- Service: Person?
        Service ->>+ RoleRepo: GetByIdAsync(consultant.RoleId)
        RoleRepo -->>- Service: Role?
        
        alt Validation error
            Service -->> ViewModel: Exception
            ViewModel ->>+ MsgService: AddErrorMessage(...)
            MsgService -->>- ViewModel: void
            ViewModel ->> StatusService: Dispose()
            ViewModel -->> ArlaEmployee: void
        else Validation succeeds
            Service ->>+ Service: UpdateNatureCheckCaseEntity()
            Service -->>- Service: NatureCheckCase
            Service ->>+ CaseRepo: UpdateAsync(existingCase)
            CaseRepo -->>- Service: void
            
            Service -->> ViewModel: NatureCheckCase
            ViewModel ->>+ MsgService: AddInfoMessage("Natur Check opgave er opdateret")
            MsgService -->>- ViewModel: void
            ViewModel ->>+ ViewModel: RefreshFarmList()
            ViewModel -->>- ViewModel: void
            ViewModel ->> StatusService: Dispose()
            ViewModel -->> ArlaEmployee: void
        end
    end
    
    deactivate ViewModel
```

**Notes:**
- All method calls use PascalCase (C# convention).
- All calls have return arrows (including void methods).
- Exception handling follows UML conventions with alt fragments for alternatives.
- Activation bars show object lifetime using automatic activation/deactivation (+/-).
- Maximum 3 levels of nested fragments for readability.
