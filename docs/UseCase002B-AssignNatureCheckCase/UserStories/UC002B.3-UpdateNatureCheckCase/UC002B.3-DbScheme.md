## Relational Database Schema â€“ UC002B.3: Update Nature Check Case Assignment

This schema builds upon UC002B.2 and focuses on Entity Framework Core implementation for update operations.

---

### **Entity Framework Core Implementation**

**Note:** In Entity Framework Core implementation, stored procedures and triggers are replaced by:

- **LINQ queries** in repositories (e.g., `INatureCheckCaseRepository.GetActiveCaseForFarmAsync()`)
- **EF Core Update operations** with optimistic concurrency control (RowVersion)
- **In-memory processing** for validations and business logic

**Repository Methods Used:**
- `INatureCheckCaseRepository.GetActiveCaseForFarmAsync()` - Retrieves active case for farm
- `INatureCheckCaseRepository.UpdateAsync()` - Updates case with optimistic concurrency check
- `INatureCheckCaseRepository.GetByIdAsync()` - Retrieves case by ID for validation

**Service Methods:**
- `NatureCheckCaseService.UpdateCaseAsync()` - Orchestrates case update
  - Validates case exists and is active
  - Checks RowVersion for concurrent modifications
  - Updates consultant, priority, notes, and AssignedAt timestamp
  - Uses EF Core's optimistic concurrency control

**No stored procedures or triggers needed** - all data access through EF Core repositories.

---

### **Business Rules**

1. Only active cases (status "Assigned" or "InProgress") can be updated
2. RowVersion must match for update to succeed (optimistic concurrency)
3. AssignedAt timestamp is updated whenever case is modified
4. If consultant changed, notifications are regenerated from updated case data when consultant views them (not stored in database)
5. All operations use Entity Framework Core repositories, not stored procedures


