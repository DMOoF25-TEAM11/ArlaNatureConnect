## Relational Database Schema â€“ UC002B.3: Update Nature Check Case Assignment

This schema builds upon UC002B.2 and adds stored procedures and triggers for update operations.

---
### **Stored Procedures for UC002B.3**

#### **usp_NatureCheckCase_Update**

**Purpose:** Updates an existing active Nature Check Case with new consultant, priority, and notes.

**Parameters:**
- `@CaseId` - `uniqueidentifier` - ID of the case to update
- `@ConsultantId` - `uniqueidentifier` - New consultant ID (if changed)
- `@Priority` - `nvarchar(50)` - New priority (if changed)
- `@Notes` - `nvarchar(MAX)` - New notes (if changed)
- `@RowVersion` - `rowversion` - Expected RowVersion for optimistic concurrency

**Returns:** Updated Nature Check Case

**Logic:**
- Validates case exists and is active
- Checks RowVersion for concurrent modifications
- Updates consultant, priority, notes, and AssignedAt timestamp
- Creates notification if consultant changed

---

#### **usp_GetActiveCaseForFarm**

**Purpose:** Retrieves the active Nature Check Case for a specific farm.

**Parameters:**
- `@FarmId` - `uniqueidentifier` - Farm ID

**Returns:** Active Nature Check Case (if exists)

---

#### **usp_Notification_MarkAsRead**

**Purpose:** Marks a notification as read when consultant is changed.

**Parameters:**
- `@CaseId` - `uniqueidentifier` - Case ID
- `@ConsultantId` - `uniqueidentifier` - Consultant ID

**Returns:** Updated notification

---

### **Triggers for UC002B.3**

#### **trg_NatureCheckCases_AfterUpdate_Notification**

**Purpose:** Creates notification for new consultant when case is updated with different consultant.

**Logic:**
- Fires after UPDATE on NatureCheckCases
- Checks if ConsultantId changed
- Creates new notification for new consultant
- Marks old consultant's notification as read

---

### **Business Rules**

1. Only active cases (status "Assigned" or "InProgress") can be updated
2. RowVersion must match for update to succeed (optimistic concurrency)
3. AssignedAt timestamp is updated whenever case is modified
4. If consultant changed, new notification is created and old one is marked as read


