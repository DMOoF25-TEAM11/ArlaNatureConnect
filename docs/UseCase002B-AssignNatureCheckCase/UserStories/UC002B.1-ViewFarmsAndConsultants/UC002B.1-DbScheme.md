## Relational Database Schema – UC002B.1: View Farms and Consultants for Assignment

---
### **Normalization**

| Normal form | Status | Explanation |
|--------------|---------|-------------|
| **1NF** | ✅ | All attributes are atomic |
| **2NF** | ✅ | All non-key attributes depend on the whole primary key |
| **3NF** | ✅ | No transitive dependencies – each entity has its own table |

---

### **Compact Notation**

|Notation|
|---------------------------------------------|
|FARMS(FarmID PK, Name, CVR, OwnerID FK, AddressID FK)|
|PERSONS(PersonID PK, FirstName, LastName, Email, RoleID FK, AddressID FK, IsActive)|
|ROLES(RoleID PK, Name)|
|ADDRESSES(AddressID PK, Street, City, PostalCode, Country)|
|NATURE_CHECK_CASES(CaseID PK, FarmID FK, ConsultantID FK, AssignedByPersonID FK, Status, Notes, Priority, CreatedAt, AssignedAt)|

---

### **Tables Used (from UC001/UC002)**

This use case reads from existing tables:
- **Farms** - Farm information
- **Persons** - Person information (for owners and consultants)
- **Roles** - Role definitions
- **Addresses** - Address information
- **NatureCheckCases** - Nature Check Case assignments

---

### **Entity Framework Core Implementation**

**Note:** In Entity Framework Core implementation, views and stored procedures are replaced by:

- **LINQ queries** in repositories (e.g., `IFarmRepository.GetAllAsync()`, `IPersonRepository.GetPersonsByRoleAsync()`)
- **DTOs** created in service layer (e.g., `FarmAssignmentOverviewDto`)
- **In-memory processing** for aggregations and transformations

**Repository Methods Used:**
- `IFarmRepository.GetAllAsync()` - Loads all farms with related entities (Owner, Address) via AutoInclude
- `IPersonRepository.GetAllAsync()` - Loads all persons with related entities (Role, Address) via AutoInclude
- `IPersonRepository.GetPersonsByRoleAsync("Consultant")` - Filters persons by Consultant role
- `IAddressRepository.GetAllAsync()` - Loads all addresses
- `INatureCheckCaseRepository.GetActiveCasesAsync()` - Loads active cases (status "Assigned" or "InProgress")

**Service Methods:**
- `NatureCheckCaseService.LoadAssignmentContextAsync()` - Orchestrates data loading
  - Loads farms, persons, addresses, and active cases
  - Maps entities to `FarmAssignmentOverviewDto` objects
  - Determines assignment status for each farm
  - Returns `NatureCheckCaseAssignmentContext` with farms and consultants

**DTOs Created:**
- `FarmAssignmentOverviewDto` - Aggregates farm data with assignment status (replaces vw_FarmAssignmentOverview)
- `NatureCheckCaseAssignmentContext` - Contains farms and consultants for assignment view

**No views or stored procedures needed** - all data access through EF Core repositories.

---

### **Legacy SQL Documentation (Not Used in EF Implementation)**

The following views and stored procedures exist only in standard SQL documentation:

#### **vw_FarmAssignmentOverview** (Replaced by FarmAssignmentOverviewDto)

**Purpose:** Aggregates farm data with assignment status for efficient display in the UI.

**EF Equivalent:** `FarmAssignmentOverviewDto` created in `NatureCheckCaseService.LoadAssignmentContextAsync()`

---

#### **vw_ConsultantsList** (Replaced by Person entities filtered by role)

**Purpose:** Provides a sorted list of all consultants for selection in the UI.

**EF Equivalent:** `IPersonRepository.GetPersonsByRoleAsync("Consultant")` returns `List<Person>`

---

#### **usp_GetFarmAssignmentOverview** (Replaced by service method)

**Purpose:** Retrieves all farms with their assignment status and consultant information.

**EF Equivalent:** `NatureCheckCaseService.LoadAssignmentContextAsync()` returns `NatureCheckCaseAssignmentContext`

---

#### **usp_GetConsultantsByRole** (Replaced by repository method)

**Purpose:** Retrieves all persons with a specific role (Consultant).

**EF Equivalent:** `IPersonRepository.GetPersonsByRoleAsync("Consultant")`

**Parameters:**
- `@RoleName` - `nvarchar(100)` - Name of the role to filter by

**EF Equivalent:** `IPersonRepository.GetPersonsByRoleAsync("Consultant")`

---

### **Indexes Used (Managed by EF Core Migrations)**

- `IX_Farms_OwnerId` - For efficient owner lookups
- `IX_Farms_AddressId` - For efficient address lookups
- `IX_Persons_RoleId` - For efficient role filtering
- `IX_NatureCheckCases_FarmId` - For efficient case lookups by farm
- `IX_NatureCheckCases_ConsultantId` - For efficient case lookups by consultant
- `IX_NatureCheckCases_Status` - For filtering active cases

**Note:** These indexes are created automatically by EF Core migrations based on entity configurations.

---

### **Business Rules**

1. Assignment status is determined by checking for active Nature Check Cases (status "Assigned" or "InProgress").
2. Only persons with the "Consultant" role are included in the consultant list.
3. Only active consultants (IsActive = 1) should be displayed.
4. Farms are sorted alphabetically by name (in ViewModel layer).
5. Consultants are sorted alphabetically by first name and last name (in ViewModel layer).
6. All data access uses Entity Framework Core repositories, not stored procedures or views.


