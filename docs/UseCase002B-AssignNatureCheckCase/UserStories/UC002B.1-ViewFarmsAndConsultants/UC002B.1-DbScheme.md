## Relational Database Schema – UC002B.1: View Farms and Consultants for Assignment

---
### **Normalization**

| Normal form | Status | Explanation |
|--------------|---------|-------------|
| **1NF** | ✅ | All attributes are atomic |
| **2NF** | ✅ | All non-key attributes depend on the whole primary key |
| **3NF** | ✅ | No transitive dependencies – each entity has its own table |

---

### **Compact Notation**

|Notation|
|---------------------------------------------|
|FARMS(FarmID PK, Name, CVR, OwnerID FK, AddressID FK)|
|PERSONS(PersonID PK, FirstName, LastName, Email, RoleID FK, AddressID FK, IsActive)|
|ROLES(RoleID PK, Name)|
|ADDRESSES(AddressID PK, Street, City, PostalCode, Country)|
|NATURE_CHECK_CASES(CaseID PK, FarmID FK, ConsultantID FK, AssignedByPersonID FK, Status, Notes, Priority, CreatedAt, AssignedAt)|

---

### **Tables Used (from UC001/UC002)**

This use case reads from existing tables:
- **Farms** - Farm information
- **Persons** - Person information (for owners and consultants)
- **Roles** - Role definitions
- **Addresses** - Address information
- **NatureCheckCases** - Nature Check Case assignments

---

### **Views Created for UC002B.1**

#### **vw_FarmAssignmentOverview**

| Attribute | Data type | Description |
|------------|------------|-------------|
| **FarmId** | `uniqueidentifier` | Farm identifier |
| **FarmName** | `nvarchar(200)` | Name of the farm |
| **CVR** | `nvarchar(50)` | CVR number |
| **OwnerFirstName** | `nvarchar(100)` | Farm owner's first name |
| **OwnerLastName** | `nvarchar(100)` | Farm owner's last name |
| **OwnerEmail** | `nvarchar(256)` | Farm owner's email |
| **Street** | `nvarchar(200)` | Farm address street |
| **City** | `nvarchar(100)` | Farm address city |
| **PostalCode** | `nvarchar(50)` | Farm address postal code |
| **Country** | `nvarchar(100)` | Farm address country |
| **HasActiveCase** | `bit` | Whether farm has an active Nature Check Case |
| **AssignedConsultantId** | `uniqueidentifier` | ID of assigned consultant (if active case exists) |
| **AssignedConsultantFirstName** | `nvarchar(100)` | Consultant's first name (if active case exists) |
| **AssignedConsultantLastName** | `nvarchar(100)` | Consultant's last name (if active case exists) |
| **Priority** | `nvarchar(50)` | Priority level (if active case exists) |
| **StatusLabel** | `nvarchar(50)` | Assignment status label ("Tilføjet" or "Ikke tilføjet") |

**Purpose:** Aggregates farm data with assignment status for efficient display in the UI.

---

#### **vw_ConsultantsList**

| Attribute | Data type | Description |
|------------|------------|-------------|
| **PersonId** | `uniqueidentifier` | Person identifier |
| **FirstName** | `nvarchar(100)` | Consultant's first name |
| **LastName** | `nvarchar(100)` | Consultant's last name |
| **Email** | `nvarchar(256)` | Consultant's email |
| **IsActive** | `bit` | Whether consultant is active |
| **FullName** | `nvarchar(201)` | Computed: FirstName + ' ' + LastName |

**Purpose:** Provides a sorted list of all consultants for selection in the UI.

---

### **Stored Procedures for UC002B.1**

#### **usp_GetFarmAssignmentOverview**

**Purpose:** Retrieves all farms with their assignment status and consultant information.

**Parameters:** None

**Returns:** Result set matching vw_FarmAssignmentOverview structure

**Logic:**
- Joins Farms, Persons (owner), Addresses, NatureCheckCases
- Determines assignment status by checking for active cases
- Includes consultant information if active case exists

---

#### **usp_GetConsultantsByRole**

**Purpose:** Retrieves all persons with a specific role (Consultant).

**Parameters:**
- `@RoleName` - `nvarchar(100)` - Name of the role to filter by

**Returns:** List of Person entities with the specified role

**Logic:**
- Joins Persons and Roles tables
- Filters by role name
- Sorts alphabetically by first name and last name

---

### **Indexes Used**

- `IX_Farms_OwnerId` - For efficient owner lookups
- `IX_Farms_AddressId` - For efficient address lookups
- `IX_Persons_RoleId` - For efficient role filtering
- `IX_NatureCheckCases_FarmId` - For efficient case lookups by farm
- `IX_NatureCheckCases_ConsultantId` - For efficient case lookups by consultant
- `IX_NatureCheckCases_Status` - For filtering active cases

---

### **Business Rules**

1. Assignment status is determined by checking for active Nature Check Cases (status "Assigned" or "InProgress").
2. Only persons with the "Consultant" role are included in the consultant list.
3. Only active consultants (IsActive = 1) should be displayed.
4. Farms are sorted alphabetically by name.
5. Consultants are sorted alphabetically by first name and last name.


