## UC002B.4 – Sequence Diagram: Create Farm (Inline)

This sequence diagram shows the detailed interaction flow when an Arla employee creates a farm inline, following Larmann's UML conventions.

**Notes:**
- All method calls use PascalCase (C# convention).
- All calls have return arrows (including void methods).
- Exception handling follows UML conventions with alt fragments for alternatives.
- Activation bars show object lifetime using automatic activation/deactivation (+/-).
- Maximum 3 levels of nested fragments for readability.

```mermaid
sequenceDiagram
    title UC002B.4 – Sequence Diagram: Create Farm (Inline)

    actor ArlaEmployee as Arla Employee
    participant ViewModel as ArlaEmployeeAssignNatureCheckViewModel
    participant Service as NatureCheckCaseService
    participant FarmRepo as IFarmRepository
    participant PersonRepo as IPersonRepository
    participant AddressRepo as IAddressRepository
    participant RoleRepo as IRoleRepository
    participant MsgService as IAppMessageService
    participant StatusService as IStatusInfoServices

    ArlaEmployee ->> ViewModel: ShowFarmEditor()
    ViewModel -->> ArlaEmployee: void
    
    ArlaEmployee ->>+ ViewModel: SaveFarmAsync(farmData)
    ViewModel ->>+ ViewModel: ValidateFarmData()
    ViewModel -->>- ViewModel: bool
    
    alt Validation fails
        ViewModel ->>+ MsgService: AddErrorMessage("Udfyld alle påkrævede felter")
        MsgService -->>- ViewModel: void
        ViewModel -->> ArlaEmployee: void
    else Validation succeeds
        ViewModel ->>+ StatusService: BeginLoading()
        StatusService -->>- ViewModel: IDisposable
        ViewModel ->>+ Service: SaveFarmAsync(request)
        
        Service ->>+ FarmRepo: GetByCvrAsync(request.Cvr)
        FarmRepo -->>- Service: Farm?
        Service ->>+ PersonRepo: GetByEmailAsync(request.OwnerEmail)
        PersonRepo -->>- Service: Person?
        
        alt Validation error
            Service -->> ViewModel: Exception
            ViewModel ->>+ MsgService: AddErrorMessage(...)
            MsgService -->>- ViewModel: void
            ViewModel ->> StatusService: Dispose()
            ViewModel -->> ArlaEmployee: void
        else Validation succeeds
            alt Owner email exists and has Farmer role
                Service ->>+ RoleRepo: GetByIdAsync(existingPerson.RoleId)
                RoleRepo -->>- Service: Role
                Service ->>+ Service: ReuseExistingPerson()
                Service -->>- Service: Person
            else Owner email does not exist
                Service ->>+ RoleRepo: GetByNameAsync("Farmer")
                RoleRepo -->>- Service: Role
                Service ->>+ PersonRepo: AddAsync(newPerson)
                PersonRepo -->>- Service: Person
            end
            
            Service ->>+ AddressRepo: AddAsync(farmAddress)
            AddressRepo -->>- Service: Address
            Service ->>+ FarmRepo: AddAsync(newFarm)
            FarmRepo -->>- Service: Farm
            Service -->> ViewModel: Farm
            ViewModel ->>+ MsgService: AddInfoMessage("Ny gård er tilføjet")
            MsgService -->>- ViewModel: void
            ViewModel ->>+ ViewModel: RefreshFarmList()
            ViewModel -->>- ViewModel: void
            ViewModel ->> StatusService: Dispose()
            ViewModel -->> ArlaEmployee: void
        end
    end
    
    deactivate ViewModel
```
