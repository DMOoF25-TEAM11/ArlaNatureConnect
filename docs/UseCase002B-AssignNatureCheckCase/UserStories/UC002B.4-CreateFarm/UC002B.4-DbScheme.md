## Relational Database Schema â€“ UC002B.4: Create Farm (Inline)

### **Entity Framework Core Implementation**

**Note:** In Entity Framework Core implementation, stored procedures are replaced by:

- **LINQ queries** in repositories (e.g., `IFarmRepository.GetByCvrAsync()`, `IPersonRepository.GetByEmailAsync()`)
- **EF Core Add operations** for creating entities
- **In-memory processing** for validations and business logic

**Repository Methods Used:**
- `IFarmRepository.GetByCvrAsync()` - Validates CVR uniqueness
- `IPersonRepository.GetByEmailAsync()` - Checks if owner email exists
- `IPersonRepository.AddAsync()` - Creates new person if needed
- `IAddressRepository.AddAsync()` - Creates new address
- `IFarmRepository.AddAsync()` - Creates new farm

**Service Methods:**
- `NatureCheckCaseService.SaveFarmAsync()` - Orchestrates farm creation
  - Validates CVR uniqueness
  - Checks if owner email exists
  - Reuses existing person if Farmer role
  - Creates new person if email doesn't exist
  - Creates address and farm
  - Uses EF Core transactions for atomicity

**No stored procedures needed** - all data access through EF Core repositories.

---

### **Business Rules**

1. CVR must be unique (validated via `IFarmRepository.GetByCvrAsync()`)
2. Owner email can exist if person has Farmer role (allows multiple farms)
3. Owner must have Farmer role to own multiple farms
4. All operations use Entity Framework Core repositories with transactions


