# UC002B.6 - Komplet Flow: Vis Konsulent Notifikationer (fra UI til Database og tilbage)

## ğŸ“ Oversigt

Dette dokument viser hele processen fra nÃ¥r konsulenten Ã¥bner siden eller vÃ¦lger sig selv, gennem alle lag, til notifikationer bliver hentet fra databasen og vist i UI'en.

**âš ï¸ VIGTIGT:** 
- **SD diagrammet** er en abstraktion der viser hovedflowet. Det skal bruges til eksamen.
- **Faktisk kode** har ekstra detaljer (exception handling, collection updates) som ikke er vist i SD'en.
- Dette dokument viser **bÃ¥de SD'en struktur** (for eksamen) og **den faktiske kode struktur** (for forstÃ¥else).

**âœ… Hvad matcher 100% mellem SD'en, koden og dette dokument:**
- âœ… **Service layer flow** - RÃ¦kkefÃ¸lge af repository kald matcher prÃ¦cist (CaseRepo â†’ FarmRepo)
- âœ… **Repository kald** - Alle metodenavne og return types matcher
- âœ… **DTO creation** - ConsultantNotificationDto oprettes identisk
- âœ… **ViewModel updates** - UpdateNotificationsList() kaldes i samme rÃ¦kkefÃ¸lge

**âš ï¸ Forskelle mellem SD'en og koden (SD'en er abstraktion):**
- SD'en viser ikke exception handling - Koden har try-catch
- SD'en viser ikke SelectedConsultant property - Koden bruger property setter til at triggere load

---

## ğŸ¯ Start: Konsulenten Ã¥bner siden eller vÃ¦lger sig selv

### 1. UI Layer (WinUI)
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ConsultantNatureCheckViewModel`  
**Property:** `SelectedConsultant` (setter, linje 56)

**Hvad sker der?**
1. Konsulenten Ã¥bner siden for at se notifikationer
2. Konsulenten vÃ¦lger sig selv fra dropdown (`SelectedConsultant`)
3. Property setter kalder automatisk `LoadNotificationsAsync()` (linje 68)

---

## ğŸ”„ ViewModel Layer (WinUI)

### 2. ViewModel - Load Method
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ConsultantNatureCheckViewModel`  
**Metode:** `LoadNotificationsAsync()` (linje 75)

**Note:** Dette flow fÃ¸lger SD diagrammet prÃ¦cist. SD diagrammet viser `LoadNotificationsAsync()` â†’ `GetNotificationsForConsultantAsync()` â†’ `UpdateNotificationsList()`.

**Faktisk kode struktur (linje 75-103):**
- **Step 1:** Tjekker om consultant er valgt (linje 77-82):
  - Hvis `_selectedConsultant == null`: Rydder notifikationer og returnerer
- **Step 2:** Try-catch block (ikke i SD'en, men i koden, linje 84-102):
  - **Step 2a:** Kalder Service (som i SD'en, linje 86-88):
    - `IReadOnlyList<ConsultantNotificationDto> notifications = await _natureCheckCaseService.GetNotificationsForConsultantAsync(_selectedConsultant.Id);`
  - **Step 2b:** Opdaterer collection (som `UpdateNotificationsList()` i SD'en, linje 90-94):
    - `_notifications.Clear();`
    - `foreach (ConsultantNotificationDto notification in notifications) { _notifications.Add(notification); }`
  - **Step 2c:** Opdaterer count (ikke i SD'en, men i koden, linje 96):
    - `NotificationCount = _notifications.Count;`
  - **Step 2d:** Exception handling (ikke i SD'en, men i koden, linje 98-102):
    - Hvis exception: Rydder notifikationer og sÃ¦tter count til 0

**Interfaces den bruger:**
- `INatureCheckCaseService` - For at hente notifikationer

**Arv:**
- Arver fra `ViewModelBase` (base klasse for alle ViewModels)

---

## ğŸ¯ Service Layer (Core)

### 3. Core Layer - Service Implementation
**Mappe:** `src/ArlaNatureConnect.Core/Services/`  
**Klasse:** `NatureCheckCaseService`  
**Metode:** `GetNotificationsForConsultantAsync()` (linje 278)

**Note:** Dette flow fÃ¸lger SD diagrammet prÃ¦cist. RÃ¦kkefÃ¸lgen af repository kald matcher SD'en.

**Hvad gÃ¸r metoden? (FÃ¸lger bÃ¥de SD diagrammet og faktisk kode - rÃ¦kkefÃ¸lge matcher prÃ¦cist)**

- **Step 1:** Henter assigned cases for konsulent: `await _natureCheckCaseRepository.GetAssignedCasesForConsultantAsync(consultantId, cancellationToken)` (linje 280)
  - Returnerer `IReadOnlyList<NatureCheckCase>`
- **Step 2:** Tjekker om cases eksisterer (linje 282-285):
  - Hvis `assignedCases.Count == 0`: Returnerer tom liste `Array.Empty<ConsultantNotificationDto>()`
- **Step 3:** Hvis cases eksisterer (som i SD'en):
  - **Step 3a:** Henter alle farm IDs (ikke i SD'en, men i koden, linje 288):
    - `HashSet<Guid> farmIds = assignedCases.Select(c => c.FarmId).ToHashSet();`
  - **Step 3b:** Henter alle farms: `await _farmRepository.GetAllAsync(cancellationToken)` (linje 291)
    - Returnerer `List<Farm>`
    - Filtrerer til kun farms med IDs fra cases (linje 291)
  - **Step 3c:** Opretter dictionary (ikke i SD'en, men i koden, linje 293):
    - `Dictionary<Guid, Farm> farmsById = farms.ToDictionary(f => f.Id, f => f);`
  - **Step 3d:** Opretter DTOs (som `CreateConsultantNotificationDtos()` i SD'en, linje 295-312):
    ```csharp
    List<ConsultantNotificationDto> notifications = new();
    foreach (NatureCheckCase caseEntity in assignedCases)
    {
        if (!farmsById.TryGetValue(caseEntity.FarmId, out Farm? farm))
            continue; // Skip if farm not found
        
        notifications.Add(new ConsultantNotificationDto
        {
            CaseId = caseEntity.Id,
            FarmId = caseEntity.FarmId,
            FarmName = farm.Name,
            AssignedAt = caseEntity.AssignedAt ?? caseEntity.CreatedAt,
            Priority = caseEntity.Priority,
            Notes = caseEntity.Notes
        });
    }
    ```
  - **Step 3e:** Sorterer notifikationer (ikke i SD'en, men i koden, linje 314):
    - `notifications.OrderByDescending(n => n.AssignedAt).ToList()`
- **Step 4:** Returnerer notifikationer (linje 316):
  - `return notifications;`

**Interfaces den bruger:**
- `INatureCheckCaseRepository` - For case operationer
- `IFarmRepository` - For farm operationer

---

## ğŸ’¾ Repository Layer (Infrastructure)

### 4. Repository Implementations
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Repositories/`  
**Base:** `Repository<TEntity>`  
**Concrete:** `NatureCheckCaseRepository`, `FarmRepository`

**Metoder der kaldes:**
- `NatureCheckCaseRepository.GetAssignedCasesForConsultantAsync()` (linje 280)
- `FarmRepository.GetAllAsync()` (linje 291)

**Hvad sker der?**
- Repositories kalder EF Core `DbContext` for at hente data
- EF Core oversÃ¦tter LINQ queries til SQL
- SQL kÃ¸res mod databasen
- Resultater mappes tilbage til C# entities

---

## ğŸ—„ï¸ EF Core Layer

### 5. EF Core - DbContext
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Persistence/`  
**Klasse:** `AppDbContext`  
**DbSets:** `NatureCheckCases`, `Farms`

**Hvad sker der?**
- EF Core oversÃ¦tter LINQ queries til SQL
- SQL kÃ¸res mod SQL Server databasen
- Resultater mappes tilbage til C# entities

**SQL der genereres (approksimativt):**
```sql
-- CaseRepo.GetAssignedCasesForConsultantAsync()
SELECT * FROM NATURE_CHECK_CASES
WHERE ConsultantId = @ConsultantId
AND Status = 'Assigned';

-- FarmRepo.GetAllAsync()
SELECT * FROM FARMS;
```

---

## ğŸ—ƒï¸ Database Layer

### 6. SQL Server Database
**Tabeller:** `NATURE_CHECK_CASES`, `FARMS`

**Hvad sker der?**
- SQL queries kÃ¸res mod databasen
- Data returneres som result sets
- EF Core mapper result sets til C# entities

---

## ğŸ”„ Tilbage gennem lagene

### 7. Data flyder tilbage gennem lagene

1. **Database â†’ EF Core:**
   - SQL result sets returneres
   - EF Core mapper til C# entities

2. **EF Core â†’ Repository:**
   - Entities returneres til repositories
   - Repositories returnerer entities til service

3. **Repository â†’ Service:**
   - Service modtager entities fra repositories
   - Service mapper entities til DTOs
   - Service returnerer `IReadOnlyList<ConsultantNotificationDto>` til ViewModel

4. **Service â†’ ViewModel:**
   - ViewModel modtager DTOs
   - ViewModel opdaterer collection: `UpdateNotificationsList()` (som i SD'en)
   - ViewModel opdaterer count: `NotificationCount = _notifications.Count`

5. **ViewModel â†’ UI:**
   - UI bindings opdateres automatisk
   - Notifikationsliste vises
   - Count opdateres

---

## ğŸ“Š Komplet Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. UI LAYER (WinUI)                                         â”‚
â”‚    Konsulenten vÃ¦lger sig selv fra dropdown                  â”‚
â”‚    â†“ kalder                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. VIEWMODEL LAYER (WinUI)                                  â”‚
â”‚    Klasse: ConsultantNatureCheckViewModel                   â”‚
â”‚    Metode: LoadNotificationsAsync() (linje 75)             â”‚
â”‚    â†“ kalder                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SERVICE LAYER (Core.Services)                           â”‚
â”‚    Klasse: NatureCheckCaseService                           â”‚
â”‚    Metode: GetNotificationsForConsultantAsync() (linje 278) â”‚
â”‚    â†“ kalder repositories i rÃ¦kkefÃ¸lge (prÃ¦cis som i SD'en):â”‚
â”‚      1. CaseRepo.GetAssignedCasesForConsultantAsync()      â”‚
â”‚      2. FarmRepo.GetAllAsync()                             â”‚
â”‚      3. CreateConsultantNotificationDtos() (internt)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. REPOSITORY LAYER (Infrastructure)                       â”‚
â”‚    Base: Repository<TEntity>                                 â”‚
â”‚    Concrete: NatureCheckCaseRepository, FarmRepository      â”‚
â”‚    Metoder: GetAssignedCasesForConsultantAsync(),           â”‚
â”‚             GetAllAsync()                                   â”‚
â”‚    â†“ bruger EF Core                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. EF CORE LAYER                                            â”‚
â”‚    Klasse: AppDbContext                                     â”‚
â”‚    DbSets: NatureCheckCases, Farms                          â”‚
â”‚    SQL: SELECT * FROM NATURE_CHECK_CASES, FARMS ...        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. DATABASE (SQL Server)                                    â”‚
â”‚    Tabeller: NATURE_CHECK_CASES, FARMS                       â”‚
â”‚    SQL: SELECT ...                                          â”‚
â”‚    â†“ returnerer data                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
         (Samme vej tilbage gennem alle lag)
```

---

## ğŸ§ª Relevante Tests

### Test 1: GetNotificationsForConsultantAsync_WithAssignedCases_ReturnsNotifications
**Fil:** `tests/ArlaNatureConnect/TestCore/Services/NatureCheckCaseServiceTests.cs`  
**Linje:** 952-990

**Hvad tester den?**
- Tester at `GetNotificationsForConsultantAsync()` returnerer notifikationer nÃ¥r cases eksisterer
- Verificerer at alle repository kald sker i korrekt rÃ¦kkefÃ¸lge
- Tester at DTOs oprettes korrekt

**Hvorfor er den god?**
- DÃ¦kker hovedflowet (happy path)
- Verificerer at notifikationer bliver oprettet korrekt
- Tester at farm data bliver inkluderet

### Test 2: LoadNotificationsAsync_WithValidConsultant_LoadsNotifications
**Fil:** `tests/ArlaNatureConnect/TestWinUI/ViewModels/Pages/ConsultantNatureCheckViewModelTests.cs`  
**Linje:** 80-103

**Hvad tester den?**
- Tester at `LoadNotificationsAsync()` kalder service og opdaterer ViewModel collection
- Verificerer at notifikationer bliver vist korrekt
- Tester at count opdateres korrekt

**Hvorfor er den god?**
- DÃ¦kker ViewModel laget
- Verificerer integration mellem ViewModel og Service
- Tester at UI bindings opdateres korrekt

---

## ğŸ“ Noter

- **DTO Pattern:** Notifikationer genereres fra `NatureCheckCase` data, ikke fra separat `Notifications` tabel
- **In-Memory Processing:** Service mapper entities til DTOs i-memory
- **Sorting:** Notifikationer sorteres efter `AssignedAt` (nyeste fÃ¸rst)
- **Empty Handling:** Hvis ingen cases eksisterer, returneres tom liste
- **Exception Handling:** ViewModel hÃ¥ndterer exceptions og rydder notifikationer
