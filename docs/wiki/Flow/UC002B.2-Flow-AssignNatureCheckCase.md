# UC002B.2 - Komplet Flow: Tildel Natur Check Opgave (fra UI til Database og tilbage)

## ğŸ“ Oversigt

Dette dokument viser hele processen fra nÃ¥r brugeren (Arla medarbejder) vÃ¦lger en gÃ¥rd og konsulent, udfylder oplysninger og trykker "Lav natur Check opgave" knappen i UI'en, gennem alle lag, til data bliver gemt i databasen og tilbage til UI'en igen.

**âš ï¸ VIGTIGT:** 
- **SD diagrammet** er en abstraktion der viser hovedflowet. Det skal bruges til eksamen.
- **Faktisk kode** har ekstra detaljer (semaphore, ExecuteWithBusyStateAsync wrapper, UpdateCaseAsync check) som ikke er vist i SD'en.
- Dette dokument viser **bÃ¥de SD'en struktur** (for eksamen) og **den faktiske kode struktur** (for forstÃ¥else).

**âœ… Hvad matcher 100% mellem SD'en, koden og dette dokument:**
- âœ… **Service layer flow** - RÃ¦kkefÃ¸lgen af repository kald matcher prÃ¦cist (FarmRepo â†’ PersonRepo â†’ RoleRepo â†’ CaseRepo)
- âœ… **Repository kald** - Alle metodenavne og return types matcher
- âœ… **Entity creation** - NatureCheckCase entity oprettes identisk
- âœ… **Exception messages** - Alle exception beskeder matcher koden

**âš ï¸ Forskelle mellem SD'en og koden (SD'en er abstraktion):**
- SD'en viser `BeginLoading()` - Koden bruger `BeginLoadingOrSaving()` (via ExecuteWithBusyStateAsync)
- SD'en viser `RefreshFarmList()` - Koden bruger `EnsureAssignmentDataAsync(forceReload: true)`
- SD'en viser kun `AssignCaseAsync()` - Koden har ogsÃ¥ `UpdateCaseAsync()` check
- SD'en viser ikke semaphore - Koden har `_assignSemaphore.Wait(0)` check
- SD'en viser ikke ExecuteWithBusyStateAsync wrapper - Koden bruger denne wrapper for exception handling

---

## ğŸ¯ Start: Brugeren udfylder form og trykker "Lav natur Check opgave"

### 1. UI Layer (WinUI)
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`  
**Command:** `AssignNatureCheckCaseCommand` (linje 276)

**Hvad sker der?**
1. Brugeren (Arla medarbejder) vÃ¦lger en gÃ¥rd fra dropdown (`SelectedFarm`)
2. Brugeren vÃ¦lger en konsulent fra dropdown (`SelectedConsultant`)
3. Brugeren udfylder valgfrie felter:
   - Priority (Lav, Normal, HÃ¸j, Haster)
   - Notes (noter om opgaven)
4. Brugeren trykker "Lav natur Check opgave" knappen
5. UI kalder `AssignNatureCheckCaseCommand.Execute(null)`

**Interface/Arv:**
- Arver fra `ViewModelBase` (base klasse)
- Bruger `INatureCheckCaseService` (dependency injection)
- Bruger `IAppMessageService` og `IStatusInfoServices` (dependency injection)

---

## ğŸ”„ ViewModel Layer (WinUI)

### 2. ViewModel - Command Handler
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`  
**Metode:** `AssignNatureCheckCaseAsync()` (linje 305)

**Note:** Dette flow fÃ¸lger SD diagrammet prÃ¦cist. SD diagrammet viser kun `AssignCaseAsync()` scenariet (ikke `UpdateCaseAsync()`).

```csharp
// Hvad sker der (som vist i SD diagrammet):
// 1. Validerer at assignment kan udfÃ¸res (CanAssignCase())
// 2. Hvis validation fails: Viser fejlbesked og returnerer
// 3. Hvis validation succeeds:
//    - Kalder BeginLoading() (StatusService)
//    - Opretter NatureCheckCaseAssignmentRequest DTO
//    - Kalder Service.AssignCaseAsync()
//    - Hvis validation error: Viser fejlbesked
//    - Hvis validation succeeds: Viser success besked og refresher liste
```

**Hvad gÃ¸r metoden? (Faktisk kode vs SD diagrammet)**

**Note:** SD diagrammet er en abstraktion. Den faktiske kode har ekstra detaljer (semaphore, ExecuteWithBusyStateAsync wrapper, UpdateCaseAsync check) som ikke er vist i SD'en. Flow dokumentet viser bÃ¥de SD'en struktur og den faktiske kode.

**Faktisk kode struktur (linje 305-354):**
- **Step 1:** Validerer at command kan udfÃ¸res (`CanAssignCase()` - tjekker at farm og consultant er valgt)
  - Hvis validation fails: Returnerer tidligt (ingen fejlbesked i koden ved CanAssignCase() == false)
- **Step 2:** Semaphore check (ikke i SD'en, men i koden):
  - `if (!_assignSemaphore.Wait(0)) return;` - Forhindrer concurrent assignments
- **Step 3:** Wrapper metode (ikke i SD'en, men i koden):
  - Kalder `ExecuteWithBusyStateAsync(async () => { ... })` som:
    - Kalder `_statusInfoServices.BeginLoadingOrSaving()` (ikke `BeginLoading()` som i SD'en)
    - SÃ¦tter `IsBusy = true`
    - HÃ¥ndterer exceptions automatisk
- **Step 4:** Opretter `NatureCheckCaseAssignmentRequest` DTO (Request participant i SD):
  ```csharp
  NatureCheckCaseAssignmentRequest request = new()
  {
      FarmId = SelectedFarm!.FarmId,
      ConsultantId = SelectedConsultant!.Id,
      AssignedByPersonId = AssignedByPersonId ?? Guid.Empty,
      Notes = AssignmentNotes,
      Priority = ToEnglish(SelectedPriority),
      AllowDuplicateActiveCase = false
  };
  ```
- **Step 5:** Tjekker om gÃ¥rd har aktiv case (ikke i SD'en, men i koden):
  - Hvis `SelectedFarm.HasActiveCase`: Kalder `UpdateCaseAsync()` (ikke vist i SD'en)
  - Hvis ikke: Kalder `AssignCaseAsync()` (som i SD'en)
- **Step 6:** Hvis validation error: `ExecuteWithBusyStateAsync` hÃ¥ndterer exception automatisk og viser fejlbesked
- **Step 7:** Hvis validation succeeds: 
  - Service returnerer `NatureCheckCase`
  - ViewModel viser success besked: `_appMessageService.AddInfoMessage("Natur Check opgave er oprettet for {FarmName}.")`
  - ViewModel resetter form: `AssignmentNotes = string.Empty`, `SelectedPriority = null`
  - ViewModel reloader data: `await EnsureAssignmentDataAsync(forceReload: true)` (ikke `RefreshFarmList()` som i SD'en)
  - `ExecuteWithBusyStateAsync` kalder automatisk `StatusService.Dispose()` via `using` statement

**Interfaces den bruger:**
- `INatureCheckCaseService` - For case assignment operationer
- `IAppMessageService` - For at vise beskeder til brugeren
- `IStatusInfoServices` - For loading state

**Arv:**
- Arver fra `ViewModelBase` (base klasse for alle ViewModels)

---

## ğŸ¯ Service Layer (Core)

### 3. Request DTO (Core.DTOs)
**Mappe:** `src/ArlaNatureConnect.Core/DTOs/`  
**Klasse:** `NatureCheckCaseAssignmentRequest`  
**Hvad er det?**
- DTO (Data Transfer Object) der overfÃ¸rer data fra ViewModel til Service
- Vises som participant "Request" i SD diagrammet
- Oprettes i ViewModel og sendes til Service

### 4. Core Layer - Service Interface
**Mappe:** `src/ArlaNatureConnect.Core/Services/`  
**Interface:** `INatureCheckCaseService`  
**Metode:** `AssignCaseAsync(NatureCheckCaseAssignmentRequest request, CancellationToken cancellationToken = default)`

**Hvad er det?**
- Interface der definerer hvad service skal kunne
- ViewModel kender kun interface, ikke konkrete implementeringer

### 5. Core Layer - Service Implementation
**Mappe:** `src/ArlaNatureConnect.Core/Services/`  
**Klasse:** `NatureCheckCaseService`  
**Metode:** `AssignCaseAsync()` (linje 101)

**Note:** Dette flow fÃ¸lger SD diagrammet prÃ¦cist. RÃ¦kkefÃ¸lgen af repository kald matcher SD'en.

```csharp
// Hvad sker der (som vist i SD diagrammet):
// 1. Henter Farm fra repository (FarmRepo.GetByIdAsync)
// 2. Henter Consultant fra repository (PersonRepo.GetByIdAsync)
// 3. Henter Consultant's Role (RoleRepo.GetByIdAsync)
// 4. Tjekker om gÃ¥rd har aktiv case (CaseRepo.FarmHasActiveCaseAsync)
// 5. Hvis validation error: Kaster Exception
// 6. Hvis validation succeeds:
//    - Opretter NatureCheckCase entity (CreateNatureCheckCaseEntity)
//    - Gemmer entity (CaseRepo.AddAsync)
//    - Returnerer entity
```

**Hvad gÃ¸r metoden? (FÃ¸lger bÃ¥de SD diagrammet og faktisk kode - rÃ¦kkefÃ¸lge matcher prÃ¦cist)**

**Note:** Service layer flow matcher 100% med bÃ¥de SD'en og koden. RÃ¦kkefÃ¸lgen af repository kald er identisk.

- **Step 0:** Validerer request ikke er null (i koden, linje 103):
  - `ArgumentNullException.ThrowIfNull(request);`
  - (Ikke eksplicit vist i SD'en, men sker fÃ¸r alle repository kald)
- **Step 1:** Henter Farm: `await _farmRepository.GetByIdAsync(request.FarmId, cancellationToken)` (linje 105)
  - Returnerer `Farm?` (nullable)
  - Hvis null: Kaster `InvalidOperationException("GÃ¥rden findes ikke lÃ¦ngere. Opdater listen og prÃ¸v igen.")`
- **Step 2:** Henter Consultant: `await _personRepository.GetByIdAsync(request.ConsultantId, cancellationToken)` (linje 106)
  - Returnerer `Person?` (nullable)
  - Hvis null: Kaster `InvalidOperationException("Den valgte konsulent findes ikke lÃ¦ngere.")`
- **Step 3:** Henter Consultant's Role: `await _roleRepository.GetByIdAsync(consultant.RoleId, cancellationToken)` (linje 107)
  - Returnerer `Role?` (nullable)
  - Validerer at role name er "Consultant" (linje 108-111)
  - Hvis ikke: Kaster `InvalidOperationException("Den valgte person har ikke konsulent-rollen.")`
- **Step 4:** Validerer `AssignedByPersonId` (linje 114-117):
  - Hvis `Guid.Empty`: Kaster `InvalidOperationException("Du mangler at vÃ¦lge en gyldig Arla medarbejder.")`
- **Step 5:** Tjekker om gÃ¥rd har aktiv case: `await _natureCheckCaseRepository.FarmHasActiveCaseAsync(farm.Id, cancellationToken)` (linje 119)
  - Returnerer `bool`
  - Hvis `true` og `AllowDuplicateActiveCase == false`: Kaster `InvalidOperationException("GÃ¥rden har allerede en aktiv Natur Check opgave.")` (linje 120-123)
- **Step 6:** Hvis validation error: Service kaster Exception og returnerer til ViewModel
- **Step 7:** Hvis validation succeeds:
  - **Step 7a:** Opretter `NatureCheckCase` entity (som `CreateNatureCheckCaseEntity()` i SD'en, linje 125-136):
    ```csharp
    NatureCheckCase entity = new()
    {
        Id = Guid.NewGuid(),
        FarmId = farm.Id,
        ConsultantId = consultant.Id,
        AssignedByPersonId = request.AssignedByPersonId,
        Status = NatureCheckCaseStatus.Assigned,
        Notes = request.Notes,
        Priority = request.Priority,
        CreatedAt = DateTimeOffset.UtcNow,
        AssignedAt = DateTimeOffset.UtcNow
    };
    ```
  - **Step 7b:** Gemmer entity: `await _natureCheckCaseRepository.AddAsync(entity, cancellationToken)` (linje 138)
    - Returnerer `NatureCheckCase` (med database-genererede vÃ¦rdier)
  - **Step 7c:** Returnerer `NatureCheckCase` til ViewModel (linje 139)

**Interfaces den bruger:**
- `IFarmRepository` - For farm operationer
- `IPersonRepository` - For person/consultant operationer
- `IRoleRepository` - For role validering
- `INatureCheckCaseRepository` - For case operationer

**Arv:**
- Implementerer `INatureCheckCaseService` interface

---

## ğŸ’¾ Repository Layer (Infrastructure)

### 6. Core Layer - Repository Interfaces
**Mappe:** `src/ArlaNatureConnect.Core/Abstract/`  
**Interfaces:**
- `IRepository<TEntity>` - Base interface for alle repositories
- `INatureCheckCaseRepository` - Extends `IRepository<NatureCheckCase>`
- `IFarmRepository` - Extends `IRepository<Farm>`
- `IPersonRepository` - Extends `IRepository<Person>`
- `IRoleRepository` - Extends `IRepository<Role>`

**Hvad er det?**
- Interfaces der definerer hvad repositories skal kunne
- Service kender kun interfaces, ikke konkrete implementeringer

### 7. Infrastructure Layer - Base Repository
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Repositories/`  
**Klasse:** `Repository<TEntity>` (base klasse)  
**Metode:** `AddAsync()` (linje 44)

```csharp
// Hvad sker der:
// 1. Opretter DbContext fra factory
// 2. TilfÃ¸jer entity til DbSet (EF Core)
// 3. Gemmer til database (SaveChangesAsync)
// 4. Reloader entity fra database
// 5. Returnerer entity
```

**Hvad gÃ¸r metoden?**
- Opretter en ny `AppDbContext` (database connection)
- FÃ¥r `DbSet<TEntity>` fra context (f.eks. `DbSet<NatureCheckCase>`)
- TilfÃ¸jer entity til DbSet: `await dbSet.AddAsync(entity, cancellationToken)`
- Gemmer til database: `await ctx.SaveChangesAsync(cancellationToken)`
- Reloader entity: `await dbSet.FindAsync([entity.Id], cancellationToken)`
- Returnerer entity

**Arv:**
- Implementerer `IRepository<TEntity>` interface

### 8. Infrastructure Layer - Concrete Repository
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Repositories/`  
**Klasse:** `NatureCheckCaseRepository`  
**Arver fra:** `Repository<NatureCheckCase>`, implementerer `INatureCheckCaseRepository`

**Hvad gÃ¸r den?**
- Arver alle CRUD operationer fra base `Repository<NatureCheckCase>` klasse
- Har specifikke metoder:
  - `GetActiveCasesAsync()` - Henter alle aktive cases
  - `FarmHasActiveCaseAsync()` - Tjekker om gÃ¥rd har aktiv case
  - `GetAssignedCasesForConsultantAsync()` - Henter cases for konsulent
  - `GetActiveCaseForFarmAsync()` - Henter aktiv case for gÃ¥rd

**Arv:**
- Arver fra `Repository<NatureCheckCase>`
- Implementerer `INatureCheckCaseRepository` interface

---

## ğŸ—„ï¸ Entity Framework Core Layer

### 9. EF Core - DbContext
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Persistence/`  
**Klasse:** `AppDbContext`  
**Hvad er det?**
- EF Core's database context - reprÃ¦senterer databasen
- Indeholder `DbSet<TEntity>` properties for hver entity type
- HÃ¥ndterer database connections og transactions

**DbSets:**
- `DbSet<NatureCheckCase> NatureCheckCases { get; set; }`
- `DbSet<Farm> Farms { get; set; }`
- `DbSet<Person> Persons { get; set; }`
- `DbSet<Role> Roles { get; set; }`

### 10. EF Core - DbSet Operations
**Hvad sker der?**
- `dbSet.AddAsync(entity)` - Markerer entity som "tilfÃ¸jet" i EF Core's change tracker
- `ctx.SaveChangesAsync()` - Sender alle Ã¦ndringer til databasen (INSERT, UPDATE, DELETE)
- `dbSet.FindAsync([id])` - Henter entity fra database baseret pÃ¥ ID

---

## ğŸ—ƒï¸ Database Layer

### 11. SQL Server Database
**Hvad sker der?**
- EF Core genererer SQL INSERT statement
- Database eksekverer INSERT statement
- Data bliver gemt i tabellen:
  - `NATURE_CHECK_CASES` tabel med:
    - `Id` (GUID)
    - `FarmId` (GUID, foreign key til FARMS)
    - `ConsultantId` (GUID, foreign key til PERSONS)
    - `AssignedByPersonId` (GUID, foreign key til PERSONS)
    - `Status` (NVARCHAR, konverteret fra enum)
    - `Notes` (NVARCHAR, nullable)
    - `Priority` (NVARCHAR, nullable)
    - `CreatedAt` (DATETIME2)
    - `AssignedAt` (DATETIME2)
- Returnerer eventuelle auto-genererede vÃ¦rdier

---

## ğŸ”„ Returvej: Fra Database tilbage til UI

### 12. Database â†’ EF Core
- Database returnerer gemt data
- EF Core mapper SQL resultat tilbage til C# entity
- `FindAsync()` returnerer `NatureCheckCase` entity med alle properties sat

### 13. EF Core â†’ Repository
- `NatureCheckCaseRepository.AddAsync()` returnerer `NatureCheckCase` entity
- Entity har nu alle database-genererede vÃ¦rdier (ID, timestamps, etc.)

### 14. Repository â†’ Service
- `NatureCheckCaseService.AssignCaseAsync()` modtager `NatureCheckCase` entity
- Returnerer entity til ViewModel

### 15. Service â†’ ViewModel
- `ArlaEmployeeAssignNatureCheckViewModel.AssignNatureCheckCaseAsync()` modtager `NatureCheckCase` entity
- Viser success besked: `_appMessageService.AddInfoMessage("Natur Check opgave er oprettet")` (som i SD'en)
- Kalder `RefreshFarmList()` (i SD'en - faktisk `EnsureAssignmentDataAsync(forceReload: true)` i koden)
- Kalder `StatusService.Dispose()`
- Returnerer til Arla Employee

### 16. ViewModel â†’ UI
- UI opdateres automatisk via data binding
- Farm listen viser at gÃ¥rd nu har aktiv case
- Form bliver reset (tom)
- Success besked vises

---

## ğŸ“Š Komplet Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. UI LAYER (WinUI)                                         â”‚
â”‚    Mappe: ViewModels/Pages/                                  â”‚
â”‚    Klasse: ArlaEmployeeAssignNatureCheckViewModel            â”‚
â”‚    Command: AssignNatureCheckCaseCommand.Execute(null)      â”‚
â”‚    â†“ kalder                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. VIEWMODEL (WinUI.Pages)                                   â”‚
â”‚    Mappe: ViewModels/Pages/                                  â”‚
â”‚    Klasse: ArlaEmployeeAssignNatureCheckViewModel            â”‚
â”‚    Metode: AssignNatureCheckCaseAsync() (linje 305)         â”‚
â”‚    â†“ opretter Request DTO (som i SD'en)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. REQUEST DTO (Core.DTOs) - Participant i SD'en            â”‚
â”‚    Mappe: DTOs/                                              â”‚
â”‚    Klasse: NatureCheckCaseAssignmentRequest                  â”‚
â”‚    Oprettes: new(farmId, consultantId, assignedByPersonId,  â”‚
â”‚              notes, priority)                                â”‚
â”‚    â†“ sendes til Service                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. SERVICE INTERFACE (Core.Services)                      â”‚
â”‚    Mappe: Services/                                          â”‚
â”‚    Interface: INatureCheckCaseService                        â”‚
â”‚    â†“ implementeret af                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. SERVICE IMPLEMENTATION (Core.Services)                  â”‚
â”‚    Mappe: Services/                                          â”‚
â”‚    Klasse: NatureCheckCaseService                            â”‚
â”‚    Metode: AssignCaseAsync() (linje 101)                    â”‚
â”‚    â†“ kalder repositories i rÃ¦kkefÃ¸lge (prÃ¦cis som i SD'en):â”‚
â”‚      1. FarmRepo.GetByIdAsync(request.FarmId)               â”‚
â”‚      2. PersonRepo.GetByIdAsync(request.ConsultantId)       â”‚
â”‚      3. RoleRepo.GetByIdAsync(consultant.RoleId)            â”‚
â”‚      4. CaseRepo.FarmHasActiveCaseAsync(farmId)             â”‚
â”‚      5. CreateNatureCheckCaseEntity() (internt)              â”‚
â”‚      6. CaseRepo.AddAsync(natureCheckCase)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. REPOSITORY INTERFACES (Core.Abstract)                   â”‚
â”‚    Mappe: Abstract/                                          â”‚
â”‚    Interfaces: IFarmRepository, IPersonRepository,          â”‚
â”‚                IRoleRepository, INatureCheckCaseRepository  â”‚
â”‚    â†“ implementeret af                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. REPOSITORY IMPLEMENTATIONS (Infrastructure)              â”‚
â”‚    Mappe: Repositories/                                      â”‚
â”‚    Base: Repository<NatureCheckCase>                         â”‚
â”‚    Concrete: NatureCheckCaseRepository                      â”‚
â”‚    Metode: AddAsync() (linje 44, arver fra base)            â”‚
â”‚    â†“ bruger                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. EF CORE LAYER                                            â”‚
â”‚    Mappe: Persistence/                                       â”‚
â”‚    Klasse: AppDbContext                                      â”‚
â”‚    DbSet: NatureCheckCases                                   â”‚
â”‚    Metoder: AddAsync(), SaveChangesAsync(), FindAsync()     â”‚
â”‚    â†“ genererer SQL                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. DATABASE (SQL Server)                                    â”‚
â”‚    Tabel: NATURE_CHECK_CASES                                  â”‚
â”‚    SQL: INSERT INTO NATURE_CHECK_CASES ...                    â”‚
â”‚    â†“ returnerer data                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
         (Samme vej tilbage gennem alle lag)
```

---

## ğŸ” Detaljeret Metode Flow

### Eksempel: Tildel ny Nature Check Case

```csharp
// 1. UI: Brugeren trykker "Lav natur Check opgave" knap
AssignNatureCheckCaseCommand.Execute(null);
//     â†‘ kalder

// 2. ViewModel: ArlaEmployeeAssignNatureCheckViewModel.AssignNatureCheckCaseAsync()
// (Faktisk kode - linje 305-354)

// Validation check
if (!CanAssignCase()) return;  // Returnerer tidligt hvis validation fails

// Semaphore check (ikke i SD'en, men i koden)
if (!_assignSemaphore.Wait(0)) return;  // Forhindrer concurrent assignments

try
{
    // Wrapper metode (ikke i SD'en, men i koden)
    await ExecuteWithBusyStateAsync(async () =>
    {
        // Opretter Request DTO (Request participant i SD'en)
        NatureCheckCaseAssignmentRequest request = new()
        {
            FarmId = SelectedFarm!.FarmId,              // Fra UI dropdown
            ConsultantId = SelectedConsultant!.Id,      // Fra UI dropdown
            AssignedByPersonId = AssignedByPersonId ?? Guid.Empty,  // Fra ViewModel property
            Notes = AssignmentNotes,                   // Fra UI textbox
            Priority = ToEnglish(SelectedPriority),     // Fra UI dropdown (konverteret)
            AllowDuplicateActiveCase = false
        };

        // Tjekker om gÃ¥rd har aktiv case (ikke i SD'en, men i koden)
        if (SelectedFarm.HasActiveCase)
        {
            await _natureCheckCaseService.UpdateCaseAsync(SelectedFarm.FarmId, request);
            _appMessageService.AddInfoMessage($"Natur Check opgave er opdateret for {SelectedFarm.FarmName}.");
        }
        else
        {
            // Kalder Service (som i SD'en - AssignCaseAsync)
            await _natureCheckCaseService.AssignCaseAsync(request);
            //     â†‘ kalder via INatureCheckCaseService interface
            
            // Success path (som i SD'en)
            _appMessageService.AddInfoMessage($"Natur Check opgave er oprettet for {SelectedFarm.FarmName}.");
        }

        // Resetter form og reloader data
        AssignmentNotes = string.Empty;
        SelectedPriority = null;
        await EnsureAssignmentDataAsync(forceReload: true);  // Faktisk metode (ikke RefreshFarmList() som i SD'en)
    });
    // ExecuteWithBusyStateAsync hÃ¥ndterer:
    // - BeginLoadingOrSaving() (ikke BeginLoading() som i SD'en)
    // - Exception handling automatisk
    // - Dispose() automatisk via using statement
}
finally
{
    _assignSemaphore.Release();  // Semaphore cleanup (ikke i SD'en)
}
```

### Service Flow (NatureCheckCaseService.AssignCaseAsync) - FÃ¸lger SD diagrammet:

```csharp
// (FÃ¸lger prÃ¦cis rÃ¦kkefÃ¸lgen fra SD diagrammet)

// Step 1: Henter Farm (som i SD'en - FarmRepo.GetByIdAsync)
Farm? farm = await _farmRepository.GetByIdAsync(request.FarmId, cancellationToken);
// Returnerer Farm? (nullable)
if (farm == null) throw new InvalidOperationException("GÃ¥rden findes ikke lÃ¦ngere...");

// Step 2: Henter Consultant (som i SD'en - PersonRepo.GetByIdAsync)
Person? consultant = await _personRepository.GetByIdAsync(request.ConsultantId, cancellationToken);
// Returnerer Person? (nullable)
if (consultant == null) throw new InvalidOperationException("Den valgte konsulent findes ikke lÃ¦ngere.");

// Step 3: Henter Consultant's Role (som i SD'en - RoleRepo.GetByIdAsync)
Role? consultantRole = await _roleRepository.GetByIdAsync(consultant.RoleId, cancellationToken);
// Returnerer Role? (nullable)
if (consultantRole?.Name != "Consultant")
    throw new InvalidOperationException("Den valgte person har ikke konsulent-rollen.");

// Step 4: Validerer AssignedByPersonId (ikke vist eksplicit i SD'en, men sker i service)
if (request.AssignedByPersonId == Guid.Empty)
    throw new InvalidOperationException("Du mangler at vÃ¦lge en gyldig Arla medarbejder.");

// Step 5: Tjekker for aktiv case (som i SD'en - CaseRepo.FarmHasActiveCaseAsync)
bool hasActiveCase = await _natureCheckCaseRepository.FarmHasActiveCaseAsync(farm.Id, cancellationToken);
// Returnerer bool
if (hasActiveCase && !request.AllowDuplicateActiveCase)
    throw new InvalidOperationException("GÃ¥rden har allerede en aktiv Natur Check opgave.");

// Step 6: Validation error path (som i SD'en)
// Hvis nogen validation fejler, kaster service Exception og returnerer til ViewModel

// Step 7: Validation succeeds path (som i SD'en)
// Step 7a: Opretter entity (som CreateNatureCheckCaseEntity() i SD'en)
NatureCheckCase entity = new()
{
    Id = Guid.NewGuid(),
    FarmId = farm.Id,
    ConsultantId = consultant.Id,
    AssignedByPersonId = request.AssignedByPersonId,
    Status = NatureCheckCaseStatus.Assigned,
    Notes = request.Notes,
    Priority = request.Priority,
    CreatedAt = DateTimeOffset.UtcNow,
    AssignedAt = DateTimeOffset.UtcNow
};

// Step 7b: Gemmer entity (som i SD'en - CaseRepo.AddAsync)
NatureCheckCase savedCase = await _natureCheckCaseRepository.AddAsync(entity, cancellationToken);
//     â†‘ kalder via INatureCheckCaseRepository interface
// Returnerer NatureCheckCase

// Step 7c: Returnerer entity til ViewModel
return savedCase;
```

### Repository Flow (NatureCheckCaseRepository.AddAsync - arver fra base):

```csharp
// NatureCheckCaseRepository.AddAsync() (arver fra Repository<NatureCheckCase>)
await using AppDbContext ctx = _factory.CreateDbContext();
DbSet<NatureCheckCase> dbSet = ctx.Set<NatureCheckCase>();
await dbSet.AddAsync(entity, cancellationToken);
await ctx.SaveChangesAsync(cancellationToken);
// â†‘ SQL: INSERT INTO NATURE_CHECK_CASES (Id, FarmId, ConsultantId, AssignedByPersonId, Status, Notes, Priority, CreatedAt, AssignedAt) VALUES (...)
NatureCheckCase? persisted = await dbSet.FindAsync([entity.Id], cancellationToken);
return persisted ?? entity;
//     â†‘ returnerer NatureCheckCase med ID fra database
```

---

## ğŸ“ Mapper og Klasser Oversigt

### WinUI Layer
- **Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`
- **Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`
- **Arver fra:** `ViewModelBase`
- **Bruger:** 
  - `INatureCheckCaseService` (injected i constructor)
  - `IAppMessageService` (injected i constructor)
  - `IStatusInfoServices` (injected i constructor)

### Core Layer
- **Mappe:** `src/ArlaNatureConnect.Core/`
  - **Services/** - Service implementeringer
    - `NatureCheckCaseService` (implementerer `INatureCheckCaseService`)
  - **Abstract/** - Repository interfaces
    - `IRepository<TEntity>` (base interface)
    - `INatureCheckCaseRepository`, `IFarmRepository`, `IPersonRepository`, `IRoleRepository`
  - **DTOs/** - Data Transfer Objects
    - `NatureCheckCaseAssignmentRequest` (DTO for assignment request)

### Infrastructure Layer
- **Mappe:** `src/ArlaNatureConnect.Infrastructure/`
  - **Repositories/** - Repository implementeringer
    - `Repository<TEntity>` (base klasse)
    - `NatureCheckCaseRepository`, `FarmRepository`, `PersonRepository`, `RoleRepository`
  - **Persistence/** - EF Core
    - `AppDbContext` (database context)
    - `Configurations/` - EF Core konfigurationer

### Domain Layer
- **Mappe:** `src/ArlaNatureConnect.Domain/`
  - **Entities/** - Domain entities
    - `NatureCheckCase`, `Farm`, `Person`, `Role`
  - **Enums/** - Domain enums
    - `NatureCheckCaseStatus` (Assigned, InProgress, Completed, Cancelled)

---

## ğŸ”— Interfaces og Arv

### Interface Hierarki:
```
IRepository<TEntity> (base interface)
  â”œâ”€â”€ INatureCheckCaseRepository
  â”œâ”€â”€ IFarmRepository
  â”œâ”€â”€ IPersonRepository
  â””â”€â”€ IRoleRepository

INatureCheckCaseService (service interface)
```

### Arv Hierarki:
```
ViewModelBase
  â””â”€â”€ ArlaEmployeeAssignNatureCheckViewModel

Repository<NatureCheckCase> (base klasse)
  â””â”€â”€ NatureCheckCaseRepository : Repository<NatureCheckCase>, INatureCheckCaseRepository

NatureCheckCaseService : INatureCheckCaseService
```

### ViewModel Dependencies:
```
ArlaEmployeeAssignNatureCheckViewModel
  â”œâ”€â”€ INatureCheckCaseService (injected som _natureCheckCaseService)
  â”œâ”€â”€ IAppMessageService (injected som _appMessageService)
  â””â”€â”€ IStatusInfoServices (injected som _statusInfoServices)
```

---

## âœ… Hvad sker der i hvert lag?

### UI Layer (ViewModel)
- âœ… Samler data fra UI form felter (farm, consultant, priority, notes)
- âœ… Validerer at data er gyldig (CanAssignCase())
- âœ… Opretter DTO (`NatureCheckCaseAssignmentRequest`)
- âœ… Kalder service layer
- âœ… Viser success/error beskeder
- âœ… Opdaterer UI via data binding
- âœ… Resetter form efter success

### Service Layer
- âœ… Orchestrerer business logic
- âœ… Validerer at farm eksisterer
- âœ… Validerer at consultant eksisterer og har korrekt role
- âœ… Validerer at AssignedByPersonId er gyldig
- âœ… Tjekker for duplicate active cases
- âœ… Opretter `NatureCheckCase` entity
- âœ… Kalder repository layer

### Repository Layer
- âœ… Skjuler database-detaljer
- âœ… Implementerer CRUD operationer
- âœ… HÃ¥ndterer EF Core operations
- âœ… Returnerer entities med database-genererede vÃ¦rdier

### EF Core Layer
- âœ… Mapper C# entities til SQL
- âœ… HÃ¥ndterer database connections
- âœ… Eksekverer SQL statements
- âœ… Mapper SQL resultater tilbage til entities

### Database Layer
- âœ… Gemmer data permanent
- âœ… HÃ¥ndterer transactions
- âœ… Returnerer data

---

## ğŸ§ª DybdegÃ¥ende Gennemgang af Tests for UC002B.2 Flow

### Test Setup - Mocks (Moq)

**Hvad er Mocks?**
- I stedet for Fake repositories, bruger disse tests Mocks (Moq framework)
- Mocks simulerer repository/service adfÃ¦rd uden faktisk at gemme data
- Lettere at teste isoleret service logik
- Giver mere kontrol over test scenarier

**Hvorfor Mocks i stedet for Fake?**
- Service layer testes isoleret fra repositories
- Verificerer at service kalder repositories korrekt
- Lettere at teste fejl scenarier (f.eks. nÃ¥r repository returnerer null)
- Tester service logik, ikke repository funktionalitet

---

### Test 1: Success Flow Test (Happy Path) â­

**Fil:** `tests/ArlaNatureConnect/TestWinUI/ViewModels/Pages/ArlaEmployeeAssignNatureCheckViewModelTests.cs`  
**Linje:** 242-285  
**Test navn:** `AssignNatureCheckCaseAsync_WithValidSelection_AssignsCase`

#### Detaljeret gennemgang:

##### ARRANGE (Forberedelse) - Linje 244-270

```csharp
// 1. Opretter test data
var farmId = Guid.NewGuid();
var consultantId = Guid.NewGuid();
var farm = new AssignableFarmViewModel(new FarmAssignmentOverviewDto
{
    FarmId = farmId,
    FarmName = "Farm1",
    Cvr = "123"
});
var consultant = new Person { Id = consultantId, FirstName = "Jane", LastName = "Smith" };

// 2. Opretter ViewModel med mock services (i test setup)
// _viewModel er allerede oprettet med mock services

// 3. TilfÃ¸jer test data til ViewModel
_viewModel.FilteredFarms.Add(farm);
_viewModel.Consultants.Add(consultant);
_viewModel.SelectedFarm = farm;
_viewModel.SelectedConsultant = consultant;
_viewModel.AssignedByPersonId = Guid.NewGuid();

// 4. Opretter expected result
var createdCase = new NatureCheckCase
{
    Id = Guid.NewGuid(),
    FarmId = farmId,
    ConsultantId = consultantId,
    Status = NatureCheckCaseStatus.Assigned
};

// 5. Setup mock service til at returnere expected result
_serviceMock.Setup(s => s.AssignCaseAsync(It.IsAny<NatureCheckCaseAssignmentRequest>(), It.IsAny<CancellationToken>()))
    .ReturnsAsync(createdCase);
```

**Hvad sker der i Arrange?**
- Opretter test data (farm, consultant, case)
- TilfÃ¸jer data til ViewModel collections
- SÃ¦tter SelectedFarm og SelectedConsultant (nÃ¸dvendigt for CanAssignCase)
- Setup mock service til at returnere success resultat

##### ACT (UdfÃ¸relse) - Linje 272-280

```csharp
// Kalder command (som brugeren ville trykke pÃ¥)
_viewModel.AssignNatureCheckCaseCommand.Execute(null);

// Vent pÃ¥ at async operation er fÃ¦rdig (poll IsBusy property)
int attempts = 0;
while (_viewModel.IsBusy && attempts < 50)
{
    await Task.Delay(10);
    attempts++;
}
```

**Hvad sker der internt?**
1. `AssignNatureCheckCaseCommand.Execute(null)` kalder `AssignNatureCheckCaseAsync()`
2. ViewModel opretter `NatureCheckCaseAssignmentRequest` DTO
3. ViewModel kalder `_serviceMock.AssignCaseAsync(request)` (mock)
4. Mock service returnerer `createdCase`
5. ViewModel viser success besked
6. ViewModel resetter form og reloader data

**Hvorfor ingen rigtig service?**
- Mock service simulerer service adfÃ¦rd
- Vi tester ViewModel logik, ikke service funktionalitet
- Tests kÃ¸rer meget hurtigere uden database
- Lettere at verificere resultater (tjekker mock calls)

##### ASSERT (Verificering) - Linje 282-285

```csharp
// 1. Verificerer at service blev kaldt korrekt
_serviceMock.Verify(s => s.AssignCaseAsync(It.IsAny<NatureCheckCaseAssignmentRequest>(), It.IsAny<CancellationToken>()), Times.Once);
// â†‘ Hvis service ikke blev kaldt, eller blev kaldt flere gange, fejler testen

// 2. Verificerer at success besked blev vist
_messageServiceMock.Verify(m => m.AddInfoMessage(It.Is<string>(s => s.Contains("Natur Check opgave er oprettet"))), Times.Once);
// â†‘ Hvis besked ikke blev vist, eller blev vist flere gange, fejler testen
```

**Hvad tester vi her?**
- âœ… Command kan udfÃ¸res nÃ¥r farm og consultant er valgt
- âœ… Service bliver kaldt med korrekt request
- âœ… Success besked bliver vist
- âœ… ViewModel hÃ¥ndterer async operation korrekt

**Hvorfor er denne test vigtig?**
- DÃ¦kker det primÃ¦re use case scenarie (happy path)
- Verificerer at hele flowet virker end-to-end (ViewModel â†’ Service)
- Sikrer at success besked vises korrekt
- Hvis denne test fejler, virker hele "tildel case" funktionaliteten ikke

---

### Test 2: Validation Test (Farm Has Active Case) â­

**Fil:** `tests/ArlaNatureConnect/TestCore/Services/NatureCheckCaseServiceTests.cs`  
**Linje:** 484-525  
**Test navn:** `AssignCaseAsync_WhenFarmHasActiveCaseAndDuplicateNotAllowed_ThrowsInvalidOperationException`

#### Detaljeret gennemgang:

##### ARRANGE (Forberedelse) - Linje 488-513

```csharp
// 1. Opretter test data
Guid farmId = Guid.NewGuid();
Guid consultantId = Guid.NewGuid();
Guid roleId = Guid.NewGuid();

Farm farm = new() { Id = farmId, Name = "Farm1", CVR = "123", OwnerId = Guid.NewGuid(), AddressId = Guid.NewGuid() };
Person consultant = new() { Id = consultantId, FirstName = "Jane", LastName = "Smith", RoleId = roleId };
Role role = new() { Id = roleId, Name = "Consultant" };

// 2. Opretter request med AllowDuplicateActiveCase = false
NatureCheckCaseAssignmentRequest request = new()
{
    FarmId = farmId,
    ConsultantId = consultantId,
    AssignedByPersonId = Guid.NewGuid(),
    AllowDuplicateActiveCase = false  // â† Vigtigt: Duplicates ikke tilladt
};

// 3. Setup mocks til at returnere valid data
_farmRepositoryMock.Setup(r => r.GetByIdAsync(farmId, cancellationToken))
    .ReturnsAsync(farm);
_personRepositoryMock.Setup(r => r.GetByIdAsync(consultantId, cancellationToken))
    .ReturnsAsync(consultant);
_roleRepositoryMock.Setup(r => r.GetByIdAsync(roleId, cancellationToken))
    .ReturnsAsync(role);

// 4. Setup mock til at returnere true for FarmHasActiveCaseAsync (gÃ¥rd har aktiv case)
_natureCheckCaseRepositoryMock.Setup(r => r.FarmHasActiveCaseAsync(farmId, cancellationToken))
    .ReturnsAsync(true);  // â† Vigtigt: GÃ¥rd har allerede aktiv case
```

**Hvad sker der i Arrange?**
- Opretter test data (farm, consultant, role) - alle gyldige
- Setup mocks til at returnere valid data
- **Vigtigt:** Setup `FarmHasActiveCaseAsync` til at returnere `true` (gÃ¥rd har aktiv case)
- Request har `AllowDuplicateActiveCase = false` (duplicates ikke tilladt)

##### ACT (UdfÃ¸relse) - Linje 515-524

```csharp
// Act & Assert
try
{
    await _service.AssignCaseAsync(request, cancellationToken);
    Assert.Fail("Expected InvalidOperationException");
    // â†‘ Hvis vi nÃ¥r her, har service ikke kastet exception - test fejler
}
catch (InvalidOperationException)
{
    // Expected - service skal kaste exception
}
```

**Hvad sker der internt?**
1. Service kalder `_farmRepository.GetByIdAsync()` - returnerer farm âœ…
2. Service kalder `_personRepository.GetByIdAsync()` - returnerer consultant âœ…
3. Service kalder `_roleRepository.GetByIdAsync()` - returnerer role âœ…
4. Service kalder `_natureCheckCaseRepository.FarmHasActiveCaseAsync()` - returnerer `true` âš ï¸
5. Service tjekker: `hasActiveCase && !request.AllowDuplicateActiveCase` â†’ `true && true` â†’ `true`
6. Service kaster `InvalidOperationException("GÃ¥rden har allerede en aktiv Natur Check opgave.")`

**Hvorfor skal service kaste exception?**
- Business rule: En gÃ¥rd mÃ¥ ikke have flere aktive cases samtidigt (medmindre `AllowDuplicateActiveCase = true`)
- Forhindrer data inkonsistens
- Giver klar fejlbesked til brugeren

##### ASSERT (Verificering) - Linje 515-524

```csharp
// Testen bruger try-catch til at verificere exception
try
{
    await _service.AssignCaseAsync(request, cancellationToken);
    Assert.Fail("Expected InvalidOperationException");
    // â†‘ Hvis vi nÃ¥r her, har service IKKE kastet exception - test fejler
}
catch (InvalidOperationException)
{
    // Expected - service kastede korrekt exception
    // Testen passerer hvis exception blev kastet
}
```

**Hvad tester vi her?**
- âœ… Service validerer at gÃ¥rd ikke har aktiv case
- âœ… Service kaster korrekt exception nÃ¥r duplicate ikke er tilladt
- âœ… Business rule bliver hÃ¥ndteret korrekt
- âœ… Repository bliver kaldt korrekt (FarmHasActiveCaseAsync)

**Hvorfor er denne test vigtig?**
- Verificerer at business rule bliver hÃ¥ndteret korrekt
- Sikrer at duplicate cases ikke kan oprettes ved fejl
- DÃ¦kker edge case scenarie (gÃ¥rd har allerede aktiv case)
- Hvis denne test fejler, kan systemet oprette duplicate cases, hvilket bryder business rules

**Hvad er forskellen fra Test 1?**
- **Test 1:** Tester ViewModel â†’ Service flow (happy path)
- **Test 2:** Tester Service validation logik (edge case)
- **Test 1:** Bruger Mocks for ViewModel test
- **Test 2:** Bruger Mocks for Service test
- **Test 1:** Verificerer at command virker
- **Test 2:** Verificerer at validation virker

---

## ğŸ“Š Test Coverage Oversigt

### Hvad dÃ¦kker testene?

| Test | Hvad den tester | Hvorfor vigtig | Type |
|------|----------------|----------------|------|
| **AssignNatureCheckCaseAsync Success** | Hele ViewModel flowet virker end-to-end | PrimÃ¦r funktionalitet | ViewModel Test |
| **AssignCaseAsync Validation** | Service validerer duplicate cases korrekt | Business rule | Service Test |

### Hvad mangler der? (Potentielle fremtidige tests)

1. **Validation Test (ViewModel)** - Teste at command ikke kan udfÃ¸res med ugyldig data
2. **Error Handling Test (ViewModel)** - Teste at fejl hÃ¥ndteres korrekt i UI
3. **Update Test** - Teste at UpdateCaseAsync virker korrekt
4. **Integration Test** - Teste med rigtig database (ikke mocks)
5. **Concurrent Assignment Test** - Teste at semaphore virker korrekt

---

## ğŸ¯ De 2 mest relevante tests:

### 1. Success Flow Test (ViewModel) â­
**Fil:** `tests/ArlaNatureConnect/TestWinUI/ViewModels/Pages/ArlaEmployeeAssignNatureCheckViewModelTests.cs`  
**Linje:** 242-285  
**Test navn:** `AssignNatureCheckCaseAsync_WithValidSelection_AssignsCase`

**Hvorfor denne test er vigtig:**
- Tester hele flowet fra UI command til service
- Verificerer at DTO bliver oprettet korrekt
- Sikrer at success besked vises korrekt
- DÃ¦kker det primÃ¦re use case scenarie (happy path)

### 2. Validation Test (Service) â­
**Fil:** `tests/ArlaNatureConnect/TestCore/Services/NatureCheckCaseServiceTests.cs`  
**Linje:** 484-525  
**Test navn:** `AssignCaseAsync_WhenFarmHasActiveCaseAndDuplicateNotAllowed_ThrowsInvalidOperationException`

**Hvorfor denne test er vigtig:**
- Verificerer at business rule bliver hÃ¥ndteret korrekt
- Sikrer at duplicate cases ikke kan oprettes ved fejl
- DÃ¦kker edge case scenarie (gÃ¥rd har allerede aktiv case)
- Tester service validation logik isoleret

---

## ğŸ” Forskelle mellem UC002B.2 Tests og UC002 Tests

### UC002B.2 Tests (NatureCheckCase):
- **Bruger Mocks (Moq)** - Simulerer service/repository adfÃ¦rd
- **Tester Service Layer** - Service testes isoleret med mocks
- **Tester ViewModel Layer** - ViewModel testes med mock services
- **Unit test stil** - Tester isoleret logik
- **Tester DTO creation** - Verificerer at DTO bliver oprettet korrekt

### UC002 Tests (Person):
- **Bruger Fake Repositories** - Simple in-memory implementeringer
- **Tester ViewModel direkte** - Ingen service layer
- **Integration test stil** - Tester hele flowet gennem ViewModel
- **Tester Address + Person** - To entities oprettes i rÃ¦kkefÃ¸lge

**Hvorfor forskellen?**
- UC002B.2 har service layer - Service orchestrerer repositories
- UC002 har ingen service layer - ViewModel kalder repositories direkte
- Forskellige test strategier for forskellige arkitekturer
- Mocks giver mere kontrol over test scenarier for service layer

---

## ğŸ¯ Konklusion

**Hele processen:**
1. **UI** â†’ Bruger udfylder form og trykker "Lav natur Check opgave"
2. **ViewModel** â†’ Validerer, opretter DTO, kalder service
3. **Service** â†’ Validerer farm, consultant, role, duplicate cases
4. **Repository Interfaces** â†’ Definerer kontrakt
5. **Repository Implementations** â†’ HÃ¥ndterer data access
6. **EF Core** â†’ Mapper til SQL
7. **Database** â†’ Gemmer data (NatureCheckCase)
8. **Tilbage gennem alle lag** â†’ Data returneres til UI, liste opdateres, form resetter

**Vigtige principper:**
- **Separation of Concerns** - Hvert lag har sin egen ansvar
- **Dependency Inversion** - ViewModel og Service bruger interfaces, ikke konkrete klasser
- **Single Responsibility** - Hver klasse har Ã©t ansvar
- **DRY (Don't Repeat Yourself)** - Base Repository klasse genbruges
- **Service Layer Pattern** - Service orchestrerer business logic og validering

**Forskelle fra UC002 (Person) flow:**
- **Service Layer** - ViewModel kalder service, ikke repositories direkte
- **DTO Pattern** - `NatureCheckCaseAssignmentRequest` bruges til at overfÃ¸re data
- **Validering i Service** - Business logic validering sker i service layer
- **Multiple Repository Calls** - Service kalder flere repositories (Farm, Person, Role, NatureCheckCase)

---

**Dette er hele flowet fra UI til database og tilbage igen for at tildele en Nature Check Case! ğŸ‰**
