# UC002B.3 - Komplet Flow: Opdater Natur Check Opgave (fra UI til Database og tilbage)

## ğŸ“ Oversigt

Dette dokument viser hele processen fra nÃ¥r brugeren (Arla medarbejder) vÃ¦lger en gÃ¥rd med aktiv case, opdaterer oplysninger og gemmer, gennem alle lag, til data bliver opdateret i databasen og tilbage til UI'en igen.

**âš ï¸ VIGTIGT:** 
- **SD diagrammet** er en abstraktion der viser hovedflowet. Det skal bruges til eksamen.
- **Faktisk kode** har ekstra detaljer (semaphore, ExecuteWithBusyStateAsync wrapper) som ikke er vist i SD'en.
- Dette dokument viser **bÃ¥de SD'en struktur** (for eksamen) og **den faktiske kode struktur** (for forstÃ¥else).

**âœ… Hvad matcher 100% mellem SD'en, koden og dette dokument:**
- âœ… **Service layer flow** - RÃ¦kkefÃ¸lgen af repository kald matcher prÃ¦cist (CaseRepo â†’ PersonRepo â†’ RoleRepo â†’ CaseRepo.UpdateAsync)
- âœ… **Repository kald** - Alle metodenavne og return types matcher
- âœ… **Entity update** - NatureCheckCase entity opdateres identisk
- âœ… **Exception messages** - Alle exception beskeder matcher koden

**âš ï¸ Forskelle mellem SD'en og koden (SD'en er abstraktion):**
- SD'en viser to separate flows: `SelectFarm()` og `UpdateNatureCheckCaseAsync()`
- Koden kalder `UpdateCaseAsync()` direkte fra `AssignNatureCheckCaseAsync()` nÃ¥r `SelectedFarm.HasActiveCase == true`
- SD'en viser `BeginLoading()` - Koden bruger `BeginLoadingOrSaving()` (via ExecuteWithBusyStateAsync)
- SD'en viser `RefreshFarmList()` - Koden bruger `EnsureAssignmentDataAsync(forceReload: true)`

---

## ğŸ¯ Start: Brugeren vÃ¦lger gÃ¥rd med aktiv case

### 1. UI Layer (WinUI)
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`  
**Property:** `SelectedFarm` (setter)

**Hvad sker der?**
1. Brugeren (Arla medarbejder) vÃ¦lger en gÃ¥rd fra dropdown (`SelectedFarm`)
2. Hvis gÃ¥rd har aktiv case (`SelectedFarm.HasActiveCase == true`):
   - UI viser "Opdater natur Check opgave" knap (i stedet for "Lav natur Check opgave")
   - ViewModel kan kalde `GetActiveCaseForFarmAsync()` for at hente case data (som i SD'en)
3. Brugeren opdaterer oplysninger (konsulent, priority, notes)
4. Brugeren trykker "Opdater natur Check opgave" knappen

**Note:** I SD'en vises `SelectFarm(farmId)` som separat flow, men i koden sker dette automatisk nÃ¥r `SelectedFarm` property sÃ¦ttes.

---

## ğŸ”„ ViewModel Layer (WinUI)

### 2. ViewModel - Update Method
**Mappe:** `src/ArlaNatureConnect.WinUI/ArlaNatureConnect.WinUI/ViewModels/Pages/`  
**Klasse:** `ArlaEmployeeAssignNatureCheckViewModel`  
**Metode:** `AssignNatureCheckCaseAsync()` (linje 305) - Samme metode som UC002B.2, men kalder `UpdateCaseAsync()` nÃ¥r `SelectedFarm.HasActiveCase == true`

**Note:** Dette flow fÃ¸lger SD diagrammet prÃ¦cist. SD diagrammet viser `UpdateNatureCheckCaseAsync()` â†’ `UpdateCaseAsync()` â†’ repositories.

**Faktisk kode struktur (linje 305-354):**
- **Step 1:** Validerer at command kan udfÃ¸res (`CanAssignCase()`)
- **Step 2:** Semaphore check (ikke i SD'en, men i koden)
- **Step 3:** Wrapper metode (ikke i SD'en, men i koden):
  - Kalder `ExecuteWithBusyStateAsync(async () => { ... })`
- **Step 4:** Opretter `NatureCheckCaseAssignmentRequest` DTO
- **Step 5:** Tjekker om gÃ¥rd har aktiv case (linje 334):
  - Hvis `SelectedFarm.HasActiveCase`: Kalder `UpdateCaseAsync()` (som i SD'en)
  - Hvis ikke: Kalder `AssignCaseAsync()` (UC002B.2 flow)
- **Step 6:** Hvis validation error: HÃ¥ndteres automatisk
- **Step 7:** Hvis validation succeeds: 
  - Viser success besked: `"Natur Check opgave er opdateret for {FarmName}."`
  - Reloader data: `EnsureAssignmentDataAsync(forceReload: true)`

---

## ğŸ¯ Service Layer (Core)

### 3. Core Layer - Service Implementation
**Mappe:** `src/ArlaNatureConnect.Core/Services/`  
**Klasse:** `NatureCheckCaseService`  
**Metode:** `UpdateCaseAsync()` (linje 142)

**Note:** Dette flow fÃ¸lger SD diagrammet prÃ¦cist. RÃ¦kkefÃ¸lgen af repository kald matcher SD'en.

**Hvad gÃ¸r metoden? (FÃ¸lger bÃ¥de SD diagrammet og faktisk kode - rÃ¦kkefÃ¸lge matcher prÃ¦cist)**

- **Step 0:** Validerer request ikke er null (linje 144):
  - `ArgumentNullException.ThrowIfNull(request);`
- **Step 1:** Henter aktiv case for gÃ¥rd: `await _natureCheckCaseRepository.GetActiveCaseForFarmAsync(farmId, cancellationToken)` (linje 147)
  - Returnerer `NatureCheckCase?` (nullable)
  - Hvis null: Kaster `InvalidOperationException("Der findes ingen aktiv Natur Check opgave for denne gÃ¥rd.")` (linje 150)
- **Step 2:** Validerer consultant: `await _personRepository.GetByIdAsync(request.ConsultantId, cancellationToken)` (linje 154)
  - Returnerer `Person?` (nullable)
  - Hvis null: Kaster `InvalidOperationException("Den valgte konsulent findes ikke lÃ¦ngere.")`
- **Step 3:** Henter consultant's role: `await _roleRepository.GetByIdAsync(consultant.RoleId, cancellationToken)` (linje 155)
  - Returnerer `Role?` (nullable)
  - Validerer at role name er "Consultant" (linje 156-159)
  - Hvis ikke: Kaster `InvalidOperationException("Den valgte person har ikke konsulent-rollen.")`
- **Step 4:** Opdaterer entity properties (som `UpdateNatureCheckCaseEntity()` i SD'en, linje 162-165):
  ```csharp
  existingCase.ConsultantId = consultant.Id;
  existingCase.Priority = request.Priority;
  existingCase.Notes = request.Notes;
  existingCase.AssignedAt = DateTimeOffset.UtcNow; // Update assignment time
  ```
- **Step 5:** Gemmer opdateringer: `await _natureCheckCaseRepository.UpdateAsync(existingCase, cancellationToken)` (linje 167)
  - Returnerer `void`
- **Step 6:** Returnerer opdateret entity (linje 168):
  - `return existingCase;`

**Interfaces den bruger:**
- `INatureCheckCaseRepository` - For case operationer
- `IPersonRepository` - For person/consultant operationer
- `IRoleRepository` - For role validering

---

## ğŸ’¾ Repository Layer (Infrastructure)

### 4. Repository Implementation
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Repositories/`  
**Base:** `Repository<NatureCheckCase>`  
**Metode:** `UpdateAsync()` (arver fra base)

**Hvad sker der?**
- Repository kalder EF Core `DbContext` for at opdatere data
- EF Core oversÃ¦tter entity changes til SQL UPDATE
- SQL kÃ¸res mod databasen
- Entity opdateres i database

---

## ğŸ—„ï¸ EF Core Layer

### 5. EF Core - DbContext
**Mappe:** `src/ArlaNatureConnect.Infrastructure/Persistence/`  
**Klasse:** `AppDbContext`  
**DbSet:** `NatureCheckCases`

**Hvad sker der?**
- EF Core's change tracker registrerer entity Ã¦ndringer
- `SaveChangesAsync()` genererer SQL UPDATE statement
- SQL kÃ¸res mod SQL Server databasen

**SQL der genereres (approksimativt):**
```sql
UPDATE NATURE_CHECK_CASES
SET ConsultantId = @ConsultantId,
    Priority = @Priority,
    Notes = @Notes,
    AssignedAt = @AssignedAt
WHERE Id = @Id;
```

---

## ğŸ—ƒï¸ Database Layer

### 6. SQL Server Database
**Tabel:** `NATURE_CHECK_CASES`

**Hvad sker der?**
- SQL UPDATE statement eksekveres
- Data bliver opdateret i tabellen
- Returnerer antal rÃ¦kker pÃ¥virket

---

## ğŸ”„ Tilbage gennem lagene

### 7. Data flyder tilbage gennem lagene

1. **Database â†’ EF Core:**
   - Database returnerer opdateret data
   - EF Core opdaterer entity i change tracker

2. **EF Core â†’ Repository:**
   - Repository returnerer opdateret entity til service

3. **Repository â†’ Service:**
   - Service modtager opdateret entity
   - Service returnerer entity til ViewModel

4. **Service â†’ ViewModel:**
   - ViewModel modtager opdateret entity
   - ViewModel viser success besked
   - ViewModel reloader data: `EnsureAssignmentDataAsync(forceReload: true)`

5. **ViewModel â†’ UI:**
   - UI bindings opdateres automatisk
   - Farm listen viser opdateret case info
   - Success besked vises

---

## ğŸ“Š Komplet Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. UI LAYER (WinUI)                                         â”‚
â”‚    Brugeren vÃ¦lger gÃ¥rd med aktiv case                      â”‚
â”‚    Opdaterer oplysninger og trykker "Opdater"               â”‚
â”‚    â†“ kalder                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. VIEWMODEL LAYER (WinUI)                                  â”‚
â”‚    Klasse: ArlaEmployeeAssignNatureCheckViewModel           â”‚
â”‚    Metode: AssignNatureCheckCaseAsync() (linje 305)        â”‚
â”‚    â†“ tjekker SelectedFarm.HasActiveCase                    â”‚
â”‚    â†“ kalder UpdateCaseAsync() (linje 336)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SERVICE LAYER (Core.Services)                           â”‚
â”‚    Klasse: NatureCheckCaseService                           â”‚
â”‚    Metode: UpdateCaseAsync() (linje 142)                    â”‚
â”‚    â†“ kalder repositories i rÃ¦kkefÃ¸lge (prÃ¦cis som i SD'en):â”‚
â”‚      1. CaseRepo.GetActiveCaseForFarmAsync(farmId)          â”‚
â”‚      2. PersonRepo.GetByIdAsync(consultantId)               â”‚
â”‚      3. RoleRepo.GetByIdAsync(consultant.RoleId)           â”‚
â”‚      4. UpdateNatureCheckCaseEntity() (internt)            â”‚
â”‚      5. CaseRepo.UpdateAsync(existingCase)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. REPOSITORY LAYER (Infrastructure)                       â”‚
â”‚    Base: Repository<NatureCheckCase>                        â”‚
â”‚    Metode: UpdateAsync() (arver fra base)                   â”‚
â”‚    â†“ bruger EF Core                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. EF CORE LAYER                                            â”‚
â”‚    Klasse: AppDbContext                                     â”‚
â”‚    DbSet: NatureCheckCases                                 â”‚
â”‚    SQL: UPDATE NATURE_CHECK_CASES ...                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. DATABASE (SQL Server)                                    â”‚
â”‚    Tabel: NATURE_CHECK_CASES                                â”‚
â”‚    SQL: UPDATE ...                                          â”‚
â”‚    â†“ returnerer data                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†‘
         (Samme vej tilbage gennem alle lag)
```

---

## ğŸ§ª Relevante Tests

**Note:** Der er ingen specifikke tests for `UpdateCaseAsync()` i test filen, men logikken testes indirekte gennem `AssignCaseAsync()` tests nÃ¥r `SelectedFarm.HasActiveCase == true`.

---

## ğŸ“ Noter

- **Update vs Create:** I koden kaldes `UpdateCaseAsync()` fra samme metode som `AssignCaseAsync()`, baseret pÃ¥ `SelectedFarm.HasActiveCase` flag. SD'en viser dem som separate flows for klarhed.
- **Entity Update:** EF Core's change tracker registrerer automatisk Ã¦ndringer til entity properties. NÃ¥r `SaveChangesAsync()` kaldes, genereres SQL UPDATE.
- **Optimistic Concurrency:** SD'en viser `CheckRowVersion()` i UC002B.3, men dette er ikke implementeret i koden endnu.
